<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit; background-repeat: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit; background-repeat: inherit; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print { 
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print { 
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) { 
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) { 
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571429rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; white-space: nowrap; background-position: inherit; background-repeat: inherit; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; border: none !important; background-position: 0px 0px !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: 0px 0px; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}


 @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>The_workflow_of_single-cell_data_analysis</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><!-- TOC --><ul><li><p><a href='#单细胞数据分析'><span>单细胞数据分析</span></a></p><ul><li><p><a href='#上游分析'><span>上游分析</span></a></p><ul><li><p><a href='#数据下载'><span>数据下载</span></a></p><ul><li><a href='#软件环境'><span>软件环境</span></a></li><li><a href='#使用sratools中的prefetch'><span>使用sratools中的prefetch</span></a></li><li><a href='#利用ascp由ftpncbi下载测序数据'><span>利用ascp由ftp.ncbi下载测序数据</span></a></li><li><a href='#提取fastq文件'><span>提取fastq文件</span></a></li></ul></li><li><p><a href='#cell-ranger'><span>Cell Ranger</span></a></p><ul><li><a href='#cell-ranger软件安装'><span>Cell Ranger软件安装</span></a></li><li><a href='#参考基因组序列的下载'><span>参考基因组序列的下载</span></a></li><li><a href='#mkfastq-拆分数据'><span>mkfastq 拆分数据</span></a></li><li><a href='#count-细胞和基因的定量'><span>🔺count 细胞和基因的定量</span></a></li><li><a href='#aggr多个文库的整合'><span>aggr多个文库的整合</span></a></li></ul></li><li><p><a href='#关于上游分析得到的数据集'><span>关于上游分析得到的数据集</span></a></p></li></ul></li><li><p><a href='#数据预处理工作流程'><span>数据预处理工作流程</span></a></p><ul><li><a href='#qc质量检测'><span>QC质量检测</span></a></li><li><a href='#归一化数据'><span>归一化数据</span></a></li><li><a href='#识别高可变基因'><span>识别高可变基因</span></a></li><li><a href='#标准化数据'><span>标准化数据</span></a></li><li><a href='#执行线性降维'><span>执行线性降维</span></a></li><li><a href='#确定数据集的维度'><span>确定数据集的“维度”</span></a></li><li><a href='#细胞周期评分和回归选择'><span>细胞周期评分和回归(选择)</span></a></li></ul></li><li><p><a href='#整合多个scrna-seq数据集'><span>整合多个scRNA-seq数据集</span></a></p><ul><li><a href='#与seurat标准处理流程一致'><span>与seurat标准处理流程一致</span></a></li><li><a href='#使用-sctransform-规范化的数据集执行整合'><span>使用 SCTransform 规范化的数据集执行整合</span></a></li></ul></li><li><p><a href='#将-seurat-与多模式数据一起使用'><span>将 Seurat 与多模式数据一起使用</span></a></p></li><li><p><a href='#下游分析'><span>下游分析</span></a></p><ul><li><p><a href='#细胞水平'><span>细胞水平</span></a></p><ul><li><p><a href='#簇'><span>簇</span></a></p><ul><li><a href='#聚类分析'><span>聚类分析</span></a></li><li><a href='#对簇进行细胞类型注释'><span>对簇进行细胞类型注释</span></a></li></ul></li><li><p><a href='#构建单细胞轨迹'><span>构建单细胞轨迹</span></a></p></li></ul></li><li><p><a href='#基因水平'><span>基因水平</span></a></p><ul><li><p><a href='#基因的差异表达分析'><span>基因的差异表达分析</span></a></p><ul><li><a href='#寻找差异表达的特征基因簇生物标志物'><span>寻找差异表达的特征基因（簇生物标志物）</span></a></li><li><a href='#与伪时间分析相关的差异表达分析'><span>与伪时间分析相关的差异表达分析</span></a></li></ul></li><li><p><a href='#基因集分析'><span>基因集分析</span></a></p><ul><li><a href='#表观遗传分析'><span>表观遗传分析</span></a></li><li><a href='#富集分析'><span>富集分析</span></a></li></ul></li><li><p><a href='#基因调控网络分析'><span>基因调控网络分析</span></a></p><ul><li><a href='#基因共表达'><span>基因共表达</span></a></li><li><a href='#蛋白质互作网络'><span>蛋白质互作网络</span></a></li><li><a href='#回归模型'><span>回归模型</span></a></li></ul></li></ul></li></ul></li></ul></li></ul><!-- /TOC --><h1 id='单细胞数据分析'><span>单细胞数据分析</span></h1><p><img src="images/2021-10-22-21-29-10.png" referrerpolicy="no-referrer">
<br><span>一个油滴 (GEM)=一个单细胞+一个凝胶微珠=一个scRNA-Seq，可以说这就是10X的基本技术原理。</span></p><p><img src="images/2021-10-22-21-37-28.png" referrerpolicy="no-referrer"></p><p><br><span> Gel beads是由凝胶磁珠和磁珠上的一段引物构成，引物序列构成依次为：</span></p><ul><li><span>全长Illumina TruSeq Read 1 测序引物（R1）</span></li><li><span>16nt 10X Barcode序列(Barcode)（每个Gel bead的10X Barcode均不相同，形成GEM（Gel Beads-in-emulsion）后用于区分细胞）</span></li><li><span>12 nt unique molecular identifier (UMI) （区分同一细胞的不同转录本并去除PCR Duplications，实现绝对定量）</span></li><li><span>30 nt poly dT反转录引物</span></li></ul><h2 id='上游分析'><span>上游分析</span></h2><p><span>最常用且最常见的的数据集主要来自10X Genomics和Smart-seq2，目前大部分的单细胞数据都来自10X Genomics，因此后续的数据处理和分析以这该类数据为例子进行讲解。</span></p><h3 id='数据下载'><span>数据下载</span></h3><h4 id='软件环境'><span>软件环境</span></h4><p><span>原始数据一般是以SRR格式存放，这个文件一般都要几个G，于是下载器首选ascp，但是直接使用ascp下载又需要配置一些参数，对于新手来说，最好是能提供一个ID，然后直接就下载，这个就需要用到</span><code>prefetch</code><span> 与</span><code>ascp</code><span>的组合了。</span></p><ol start='' ><li><p><span>prefetch</span>
<span>默认情况下，</span><code>prefetch</code><span>是利用https方式去下载原始数据。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda install <span class="cm-attribute">-c</span> daler sratoolkit</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">prefetch <span class="cm-attribute">-h</span> <span class="cm-comment"># 可以显示帮助文档就说明安装成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如果要下载数据比如SRR文件，直接加ID号，指定输出目录就好</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">prefetch SRRxxxxxxx <span class="cm-attribute">-O</span> PATH</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre></li><li><p><span>ascp</span>
<code>prefetch</code><span>速度有一定的限制。因此我们需要先安装一款叫做&quot;aspera&quot;的下载工具，它是IBM旗下的商业高速文件传输软件，与NCBI和EBI有协作合同。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">wget</span> http://download.asperasoft.com/download/sw/connect/3.7.4/aspera-connect-3.7.4.147727-linux-64.tar.gz</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tar zxvf aspera-connect-3.7.4.147727-linux-64.tar.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#安装</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">bash</span> aspera-connect-3.7.4.147727-linux-64.sh</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 然后cd到根目录下看看是不是存在了.aspera文件夹，有的话表示安装成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> &amp;&amp; <span class="cm-builtin">ls</span> <span class="cm-attribute">-a</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 将aspera软件加入环境变量，并激活</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> <span class="cm-string">'export PATH=~/.aspera/connect/bin:$PATH'</span> &gt;&gt; ~/.bashrc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">source</span> ~/.bashrc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 最后检查ascp是不是能用了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ascp <span class="cm-attribute">--help</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>如果报错：</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ascp: Failed to open TCP connection <span class="cm-keyword">for</span> SSH, exiting.</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Session Stop  (Error: Failed to open TCP connection <span class="cm-keyword">for</span> SSH)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 官网给出的解决办法是：https://support.asperasoft.com/hc/en-us/articles/216126918-Error-44-UDP-session-initiation-fatal-error</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">On many Linux systems the default firewall can be configured with iptables. You will have to allow all incoming and outgoing traffic on UDP port <span class="cm-number">33001</span> (or whatever your Aspera UDP port is), which you can <span class="cm-keyword">do</span> with the following commands:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 使用下面这两个命令(但需要管理员权限)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># iptables -I INPUT -p tcp --dport 33001 -j ACCEPT</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># iptables -I OUTPUT -p tcp --dport 33001 -j ACCEPT</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><h4 id='使用sratools中的prefetch'><span>使用sratools中的prefetch</span></h4><p><span>以GSE117988的数据集为例。</span></p><ol start='' ><li><span>打开</span><a href='https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE117988' target='_blank' class='url'>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE117988</a></li><li><span>点击SRA这里的</span><code>SRP155988</code>
<img src="images/2021-10-22-21-04-05.png" referrerpolicy="no-referrer"></li><li><code>send to</code><span> =&gt; </span><code>Run Selector</code><span> =&gt; </span><code>Go</code><span> </span>
<img src="images/2021-10-22-21-04-47.png" referrerpolicy="no-referrer"></li><li><span>下载Accession List，然后就得到了一个文本文件，列出了6个SRR ID号</span>
<img src="images/2021-10-22-21-05-12.png" referrerpolicy="no-referrer"></li><li><span>下载代码</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">wkd</span><span class="cm-operator">=</span>/home/project/single-cell/MCC</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> <span class="cm-def">$wkd</span>/raw</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># for patient 2586-4</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &gt;SRR_Acc_List-2586-4.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SRR7722937</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SRR7722938</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SRR7722939</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SRR7722940</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SRR7722941</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SRR7722942</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> SRR_Acc_List-2586-4.txt |while read i</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">do</span> prefetch <span class="cm-def">$i</span> <span class="cm-attribute">-O</span> <span class="cm-quote">`pwd`</span> &amp;&amp; <span class="cm-builtin">echo</span> <span class="cm-string">"** </span><span class="cm-def">${i}</span><span class="cm-string">.sra done **"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">done</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 一般2.6G文件下载2分钟左右</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 330px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><h4 id='利用ascp由ftpncbi下载测序数据'><span>利用ascp由ftp.ncbi下载测序数据</span></h4><ol start='' ><li><span>进入官网</span><a href='https://www.ebi.ac.uk/ena' target='_blank' class='url'>https://www.ebi.ac.uk/ena</a><span> ，搜索想下载的SRA号</span>
<img src="images/2021-10-22-21-07-38.png" referrerpolicy="no-referrer"></li><li><span>选择SRR这里</span>
<img src="images/2021-10-22-21-07-56.png" referrerpolicy="no-referrer"></li><li><span>EBI可以直接下载fastq格式文件（左边方框），如果要下载sra就复制右边红色方框中链接</span>
<img src="images/2021-10-22-21-08-39.png" referrerpolicy="no-referrer"></li><li><span>然后利用这个代码下载</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ascp <span class="cm-attribute">-QT</span> <span class="cm-attribute">-l</span> 300m <span class="cm-attribute">-P33001</span> <span class="cm-attribute">-i</span> ~/.aspera/connect/etc/asperaweb_id_dsa.openssh era-fasp@fasp.sra.ebi.ac.uk:vol1/srr/SRR772/009/SRR7722939 ./</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><h4 id='提取fastq文件'><span>提取fastq文件</span></h4><p><span>我们使用fastq-dump这款软件，它是sra-tool中的一个工具，使用conda安装即可。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">conda install <span class="cm-attribute">-c</span> bioconda sra-tools</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">wkd</span><span class="cm-operator">=</span>/home/project/single-cell/MCC ///路径</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> <span class="cm-def">$wkd</span>/raw/P2586-4</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> SRR_Acc_List-2586-4.txt |while read i</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">time fastq-dump <span class="cm-attribute">--gzip</span> <span class="cm-attribute">--split-files</span> <span class="cm-attribute">-A</span> <span class="cm-def">$i</span> <span class="cm-def">${i}</span>.sra &amp;&amp; <span class="cm-builtin">echo</span> <span class="cm-string">"** </span><span class="cm-def">${i}</span><span class="cm-string">.sra to fastq done **"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">done</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><ul><li><span>--gzip将生成的结果fastq文件进行压缩</span></li><li><span>--split-files：首先它是分割的意思，-3实际上指的是分成3个文件。</span></li><li><span>-A指定输出的文件名</span></li></ul><p><span>根据Cell Ranger说明书对批量处理得到的三个文件更改名字方便后续分析：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 比如，将原来的SRR7692286_1.fastq.gz改成SRR7692286_S1_L001_I1_001.fastq.gz</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 依次类推，将原来_2的改成R1，将_3改成R2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> SRR_Acc_List-9245-3.txt | <span class="cm-keyword">while</span> read i ;do (mv <span class="cm-def">${i}</span>_1*.gz <span class="cm-def">${i}</span>_S1_L001_I1_001.fastq.gz;mv <span class="cm-def">${i}</span>_2*.gz <span class="cm-def">${i}</span>_S1_L001_R1_001.fastq.gz;mv <span class="cm-def">${i}</span>_3*.gz <span class="cm-def">${i}</span>_S1_L001_R2_001.fastq.gz);done</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p><img src="images/2021-10-22-22-00-56.png" referrerpolicy="no-referrer">
<span>其中，</span><mark><span>I1为index，R1是barcode和UMI，R2是测序read，是最长的。</span></mark></p><ul><li><p><strong><span>为什么10x单细胞转录组表达矩阵有3个文件</span></strong></p><p><span>因为10x单细胞转录组表达矩阵里面的0值非常多，所以换成3个文件存储更节省空间。</span></p></li></ul><h3 id='cell-ranger'><span>Cell Ranger</span></h3><p><img src="images/2021-10-23-09-25-49.png" referrerpolicy="no-referrer">
<span>它主要包括四个主要基因表达分析流程：</span></p><ul><li><code>mkfastq</code><span> ： 它借鉴了Illumina的</span><code>bcl2fastq</code><span> ，可以将一个或多个lane中的混样测序样本按照index标签生成样本对应的fastq文件</span></li><li><code>count</code><span>：利用</span><code>mkfastq</code><span>生成的fq文件，进行比对(基于STAR)、过滤、UMI计数。利用细胞的barcode生成gene-barcode矩阵，然后进行样本分群、基因表达分析。</span></li><li><code>aggr</code><span> ：接受cellranger count的输出数据，将同一组的不同测序样本的表达矩阵整合在一起，比如tumor组原来有4个样本，PBMC组有两个样本，现在可以使用aggr生成最后的tumor和PBMC两个矩阵，并且进行标准化去掉测序深度的影响</span></li><li><code>reanalyze</code><span> ：接受cellranger </span><code>count</code><span>或cellranger </span><code>aggr</code><span>生成的gene-barcode矩阵，使用不同的参数进行降维、聚类</span></li></ul><p><span>它的结果主要是包含有细胞信息的BAM, MEX, CSV, HDF5 and HTML文件</span></p><h4 id='cell-ranger软件安装'><span>Cell Ranger软件安装</span></h4><p><span>Cell Ranger默认在本地运行(或者使用</span><code>--jobmode=local</code><span>指定)，它会占用90%的空余内存以及所有空余的CPU。如果要进行资源限制，可以使用</span><code>—localmem</code><span>或者</span><code>--localcores</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.0版本下载(732M)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-o</span> cellranger-2.0.2.tar.gz <span class="cm-string">"http://cf.10xgenomics.com/releases/cell-exp/cellranger-2.0.2.tar.gz?Expires=1557256518&amp;Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cDovL2NmLjEweGdlbm9taWNzLmNvbS9yZWxlYXNlcy9jZWxsLWV4cC9jZWxscmFuZ2VyLTIuMC4yLnRhci5neiIsIkNvbmRpdGlvbiI6eyJEYXRlTGVzc1RoYW4iOnsiQVdTOkVwb2NoVGltZSI6MTU1NzI1NjUxOH19fV19&amp;Signature=HoJUuPo4iTFdQgzFU1GH7uKf3uGitQxTjB6WOA9qGPlejf7tNcBPjO65WuSUZ~w8WWdeAvky-oV7XGfheY-bUr2b7QHr7jQEqc84cyU~PLvT~fYjkgC7cG7nlpbJOT~b7U~YH9amvR~SCLlyynp7scPDIA~9~keCYrIPgevTf2QyktybuSyjNTwugefOic~~XFkc9lrS~WQ9MNA1CLl4ExlQKsxWS77PEB6mwrMZXX65obDnZW9fIs3dIny6H5YoadbkgmsT52jmLien6PsG1g2jpAO90pPuHoru8LL64Q9gmB3I0nJAqi3EmrO3GKnUpHUhGb6doKmjSN6XccpmsA__&amp;Key-Pair-Id=APKAI7S6A5RYOXBWRPDA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.1版本下载</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-o</span> cellranger-2.1.1.tar.gz <span class="cm-string">"http://cf.10xgenomics.com/releases/cell-exp/cellranger-2.1.1.tar.gz?Expires=1557260110&amp;Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cDovL2NmLjEweGdlbm9taWNzLmNvbS9yZWxlYXNlcy9jZWxsLWV4cC9jZWxscmFuZ2VyLTIuMS4xLnRhci5neiIsIkNvbmRpdGlvbiI6eyJEYXRlTGVzc1RoYW4iOnsiQVdTOkVwb2NoVGltZSI6MTU1NzI2MDExMH19fV19&amp;Signature=RNQd-gTASTQhtnUSBfQWrnqo6Pyy2wDXtV5tlxkG97727GvoRhMqFXbEsz4gJl2BMckdVvW3S1tZRwRo5pmxPzmhq-8RKxf99pGqlzo84HYqhbIRkxXlIbLbj-u3PUJqo8cesWpbSVSKkS2TCNS-9GMFNieQswqMS2-DN4BqoBOJnWr7T4wlOMd9hypXWwOsW2P2fqaM-WP2ooMyo-oIxm3y9gDghXdDEP5lvHU7GCQcFGGexkdIrD6S5p8JPJ1DB5XieGrtEuP1YVp6tLMGXFoRWXS8dQLI1egWDYlOuRaiQgLIb3o5ZxBg5NpzLPP5kDHMAVzJFdBpf~~rkyNYTA__&amp;Key-Pair-Id=APKAI7S6A5RYOXBWRPDA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### 解压</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tar zxvf cellranger-2.0.2.tar.gz</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 528px;"></div><div class="CodeMirror-gutters" style="display: none; height: 528px;"></div></div></div></pre><h4 id='\b参考基因组序列的下载'><span>参考基因组序列的下载</span></h4><ol start='' ><li><span>根据需求下载基因组注释文件</span>
<span>以下文件是基于ensebl数据库的hg38人类基因组注释文件，但是不能直接使用网站下载的基因组与注释文件，需要过滤一下。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-O</span> http://cf.10xgenomics.com/supp/cell-exp/refdata-cellranger-GRCh38-1.2.0.tar.gz</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 然后解压</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tar <span class="cm-attribute">-xzvf</span> refdata-cellranger-GRCh38-1.2.0.tar.gz</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><ol start='2' ><li><span>自己尝试构建(重点和难点)</span>
<span>但是很多时候，我们需要根据自己的需要，自定义一套参考信息，但需要注意以下问题：</span></li></ol><ul><li><span>参考序列只能有很少的 overlapping gene annotations，因为reads比对到多个基因会导致流程检测的分子数更少(它只要uniquely mapped的结果)</span></li><li><span>FASTA与GTF比对和STAR兼容，GTF文件的第三列（feature type）必须有exon</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 下载基因组</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">wget</span> ftp://ftp.ensembl.org/pub/release-84/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">gunzip Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 下载注释</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">wget</span> ftp://ftp.ensembl.org/pub/release-84/gtf/homo_sapiens/Homo_sapiens.GRCh38.84.gtf.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">gunzip Homo_sapiens.GRCh38.84.gtf.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 软件构建注释</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 首先利用mkgtf过滤GTF文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># mkgtf &lt;input_gtf&gt; &lt;output_gtf&gt; [--attribute=KEY:VALUE...]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cellranger mkgtf Homo_sapiens.GRCh38.84.gtf Homo_sapiens.GRCh38.84.filtered.gtf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:protein_coding \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:lincRNA \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:antisense \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_LV_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_V_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_V_pseudogene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_D_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_J_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_J_pseudogene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_C_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:IG_C_pseudogene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:TR_V_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:TR_V_pseudogene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:TR_D_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:TR_J_gene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:TR_J_pseudogene \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--attribute</span><span class="cm-operator">=</span>gene_biotype:TR_C_gene</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># gene_biotype（也就是基因的生物类型）的键值对</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ cat</span> Homo_sapiens.GRCh38.84.filtered.gtf |grep <span class="cm-attribute">-v</span> <span class="cm-string">"#"</span> |awk <span class="cm-attribute">-v</span> <span class="cm-def">FS</span><span class="cm-operator">=</span><span class="cm-string">'gene_biotype '</span> <span class="cm-string">'NF&gt;1{print $2}'</span>|awk <span class="cm-attribute">-F</span> <span class="cm-string">";"</span> <span class="cm-string">'{print $1}'</span>|sort | uniq <span class="cm-attribute">-c</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">213</span> <span class="cm-string">"IG_C_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">33</span> <span class="cm-string">"IG_C_pseudogene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">152</span> <span class="cm-string">"IG_D_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">76</span> <span class="cm-string">"IG_J_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-number">9</span> <span class="cm-string">"IG_J_pseudogene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">1209</span> <span class="cm-string">"IG_V_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">646</span> <span class="cm-string">"IG_V_pseudogene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">125</span> <span class="cm-string">"TR_C_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">16</span> <span class="cm-string">"TR_D_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">316</span> <span class="cm-string">"TR_J_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">12</span> <span class="cm-string">"TR_J_pseudogene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">848</span> <span class="cm-string">"TR_V_gene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">110</span> <span class="cm-string">"TR_V_pseudogene"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-number">45662</span> <span class="cm-string">"antisense"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-number">58181</span> <span class="cm-string">"lincRNA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">2337766</span> <span class="cm-string">"protein_coding"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 利用mkref构建参考索引，软件利用构建好的注释，去构建需要的基因组</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cellranger mkref <span class="cm-attribute">--genome</span><span class="cm-operator">=</span>GRCh38 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--fasta</span><span class="cm-operator">=</span>Homo_sapiens.GRCh38.dna.primary_assembly.fa \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--genes</span><span class="cm-operator">=</span>Homo_sapiens.GRCh38.84.filtered.gtf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--ref-version</span><span class="cm-operator">=</span><span class="cm-number">1</span>.2.0</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1232px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1232px;"></div></div></div></pre><h4 id='mkfastq-拆分数据'><span>mkfastq 拆分数据</span></h4><p><mark><span>一般来说，这个步骤我们不会使用，从数据库下载可以得到fastq文件，而且数据库一般不会给出BCLs格式的原始文件。</span>
<span>目的：</span><mark><span>将每个flowcell 的Illumina sequencer&#39;s base call files (BCLs)转为fastq文件</span></mark></p><p><span>特色： 它借鉴了Illumina出品的</span><code>bcl2fastq</code><span>，另外增加了：</span></p><ul><li><span>将10X 样本index名称与四种寡核苷酸对应起来，比如A1孔是样本SI-GA-A1，然后对应的寡核苷酸是GGTTTACT, CTAAACGG, TCGGCGTC, and AACCGTAA ，那么程序就会去index文件中将存在这四种寡核苷酸的fastq组合到A1这个样本</span></li><li><span>提供质控结果，包括barcode 质量、总体测序质量如Q30、R1和R2的Q30碱基占比、测序reads数等</span></li><li><span>可以使用10X简化版的样本信息表</span>
<img src="images/2021-10-23-09-47-55.png" referrerpolicy="no-referrer"></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 第一种</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ cellranger</span> mkfastq <span class="cm-attribute">--id</span><span class="cm-operator">=</span>bcl \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--run</span><span class="cm-operator">=</span>/path/to/bcl \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--samplesheet</span><span class="cm-operator">=</span>samplesheet-1.2.0.csv</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--jobmode</span><span class="cm-operator">=</span>local </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--localcores</span><span class="cm-operator">=</span><span class="cm-number">20</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--localmem</span><span class="cm-operator">=</span><span class="cm-number">80</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 第二种</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ cellranger</span> mkfastq <span class="cm-attribute">--id</span><span class="cm-operator">=</span>bcl \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--run</span><span class="cm-operator">=</span>/path/to/bcl \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--csv</span><span class="cm-operator">=</span>simple-1.2.0.csv</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--jobmode</span><span class="cm-operator">=</span>local </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--localcores</span><span class="cm-operator">=</span><span class="cm-number">20</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--localmem</span><span class="cm-operator">=</span><span class="cm-number">80</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 其中id指定输出目录的名称</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># run指的是下机的原始BCL文件目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># -–samplesheet ：样品信息列表--共三列（lane id ,sample name ,index name)，注意要控制好核心数和内存数</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><h4 id='🔺count-细胞和基因的定量'><span>🔺count 细胞和基因的定量</span></h4><p><span>这个过程是最重要的，它完成细胞与基因的定量，它将比对、质控、定量都包装了起来。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 这是示例，不是真实数据 #</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cellranger count <span class="cm-attribute">--id</span><span class="cm-operator">=</span>sample345 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--transcriptome</span><span class="cm-operator">=</span>/opt/refdata-cellranger-GRCh38-1.2.0 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--fastqs</span><span class="cm-operator">=</span>/home/scRNA/runs/HAWT7ADXX/outs/fastq_path \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--sample</span><span class="cm-operator">=</span>mysample \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--expect-cells</span><span class="cm-operator">=</span><span class="cm-number">1000</span> \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--nosecondary</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># id指定输出文件存放目录名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># transcriptome指定与CellRanger兼容的参考基因组</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># fastqs指定mkfastq或者自定义的测序文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># sample要和fastq文件的前缀中的sample保持一致，作为软件识别的标志</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># expect-cells指定复现的细胞数量，这个要和实验设计结合起来</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># nosecondary 只获得表达矩阵，不进行后续的降维、聚类和可视化分析(因为后期会自行用R包去做)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><p><span>输出文件：</span></p><ul><li><span>web_summary.html：官方说明 summary HTML file </span></li><li><span>metrics_summary.csv：CSV格式数据摘要</span></li><li><span>possorted_genome_bam.bam：比对文件</span></li><li><span>possorted_genome_bam.bam.bai：索引文件</span></li><li><mark><span>filtered_gene_bc_matrices：是重要的一个目录，下面又包含了 barcodes.tsv.gz、features.tsv.gz、matrix.mtx.gz，是下游Seurat、Scater、Monocle等分析的输入文件</span></mark></li><li><span>filtered_feature_bc_matrix.h5：过滤掉的barcode信息HDF5 format</span></li><li><span>raw_feature_bc_matrix：原始barcode信息</span></li><li><span>raw_feature_bc_matrix.h5：原始barcode信息HDF5 format</span></li><li><mark><span>analysis：数据分析目录，下面又包含聚类clustering（有graph-based &amp; k-means）、差异分析diffexp、主成分线性降维分析pca、非线性降维tsne</span></mark></li><li><span>molecule_info.h5：下面进行aggregate使用的文件</span></li><li><span>cloupe.cloupe：官方可视化工具Loupe Cell Browser 输入文件</span></li></ul><h4 id='aggr多个文库的整合'><span>aggr多个文库的整合</span></h4><p><span>当处理多个生物学样本或者一个样本存在多个重复/文库时，最好的操作就是先分别对每个文库进行单独的count定量，然后将定量结果利用aggr组合起来。</span></p><ol start='' ><li><span>得到count结果</span></li><li><span>构建Aggregation CSV</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AGG123_libraries.csv</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">library_id,molecule_h5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">LV123,/opt/runs/LV123/outs/molecule_info.h5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">LB456,/opt/runs/LB456/outs/molecule_info.h5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">LP789,/opt/runs/LP789/outs/molecule_info.h5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 其中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># molecule_h5：文件molecule_info.h5 file的路径</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><ol start='3' ><li><span>运行aggr</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cellranger aggr <span class="cm-attribute">--id</span><span class="cm-operator">=</span>AGG123 \</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-attribute">--csv</span><span class="cm-operator">=</span>AGG123_libraries.csv \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-attribute">--normalize</span><span class="cm-operator">=</span>mapped</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 结果输出到AGG123这个目录中</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><h3 id='关于上游分析得到的数据集'><span>关于上游分析得到的数据集</span></h3><p><span>e.g.10X Genomics 免费提供的外周血单核细胞 (PBMC) 数据集</span>
<img src="images/2021-10-24-21-32-14.png" referrerpolicy="no-referrer"></p><ul><li><span>barcodes.tsv：每个细胞的编码，由ATCG四个碱基排列组合形成的不同的14个碱基组合</span></li><li><span>genes.tsv：基因的ensembl ID 和gene symbol</span>
<img src="images/2021-10-24-21-32-37.png" referrerpolicy="no-referrer"></li><li><span>matrix.mtx：每个细胞不同基因所测得的表达矩阵，第一列是基因ID，与genes.tsv进行对应转换；第二列是细胞的编号，与barcodes.tsv进行匹配；第三列是基因的表达量（TPM）。</span></li></ul><h2 id='数据预处理工作流程'><span>数据预处理工作流程</span></h2><p><strong><span>加载Seurat包和读取数据</span></strong></p><p><span>使用Read10X()函数读取数据文件，并构建成</span><mark><span>行名为基因名，列名为细胞的barcode的 (UMI) 计数矩阵</span></mark><span>，其中可储存单细胞数据集的稀疏矩阵和后续分析结果。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># BiocManager::install("Seurat")</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">dplyr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">patchwork</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Load the PBMC dataset</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc.data</span><span class="cm-operator cm-arrow">&lt;-</span><span class="cm-variable">Read10X</span>(<span class="cm-variable">data.dir</span><span class="cm-operator">=</span> <span class="cm-string">"../data/pbmc3k/filtered_gene_bc_matrices/hg19/"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Initialize the Seurat object with the raw (non-normalized data).</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateSeuratObject</span>(<span class="cm-variable">counts</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc.data</span>, <span class="cm-variable">project</span> <span class="cm-operator">=</span> <span class="cm-string">"pbmc3k"</span>, <span class="cm-variable">min.cells</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>, <span class="cm-variable">min.features</span> <span class="cm-operator">=</span> <span class="cm-number">200</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><h3 id='qc质量检测'><span>QC质量检测</span></h3><blockquote><p><span>QC质量指标：</span></p></blockquote><ul><li><p><span>每个细胞检测到的基因数目</span></p><ul><li><span>低质量细胞或空液滴通常只有很少的基因</span></li><li><span>细胞双联体或多重联体可能表现出异常高的基因计数</span></li></ul></li><li><p><span>每个细胞中检测到的分子总数</span></p></li><li><p><span>低质量/垂死的细胞通常表现出广泛的线粒体污染，所以使用该PercentageFeatureSet()函数计算线粒体 QC 指标，其中MT-开头的基因认为是线粒体基因</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">###### 细胞质控</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">### 计算质控指标</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 计算细胞中线粒体基因比例</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pbmc</span>[[<span class="cm-string">"percent.mt"</span>]] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">PercentageFeatureSet</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">pattern</span> <span class="cm-operator">=</span> <span class="cm-string">"^MT-"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 质控前小提琴图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">plots</span> <span class="cm-operator">=</span> <span class="cm-builtin">list</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">seq_along</span>(<span class="cm-variable">plot.featrures</span>)){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">plots</span>[[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> <span class="cm-variable">VlnPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-variable">group</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">plot.featrures</span>[<span class="cm-variable">i</span>]) <span class="cm-operator">+</span> <span class="cm-variable">theme.set2</span> <span class="cm-operator">+</span> <span class="cm-variable">NoLegend</span>()}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">violin</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">wrap_plots</span>(<span class="cm-variable">plots</span> <span class="cm-operator">=</span> <span class="cm-variable">plots</span>, <span class="cm-variable">nrow</span><span class="cm-operator">=</span><span class="cm-number">2</span>) &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">ggsave</span>(<span class="cm-string">"QC/vlnplot_before_qc.pdf"</span>, <span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">violin</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">9</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>) </span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p><span>因此，我们通过将QC指标可视化，并使用这些指标来过滤不符合指标的细胞。</span><br></p><p><img src="images/2021-10-24-21-49-22.png" referrerpolicy="no-referrer"></p><p><br><span>从图中我们可以观察到nFeature_RNA，nCount_RNA和percent.mt的数量大部分都在小提琴图的底部，因此需要过滤低质量的细胞，其中nCount_RNA为每个细胞的UMI数目，nFeature_RNA为每个细胞所检测到的基因数目。</span>
<br><mark><span>通常，我们过滤具有超过 2,500 或少于 200 的基因数目的细胞和线粒体计数 &gt; 5% 的细胞。</span></mark></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### 质控</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 设置质控标准</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">minGene</span><span class="cm-operator">=</span><span class="cm-number">500</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">maxGene</span><span class="cm-operator">=</span><span class="cm-number">2500</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">maxUMI</span><span class="cm-operator">=</span><span class="cm-number">22000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pctMT</span><span class="cm-operator">=</span><span class="cm-number">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 数据质控并绘制小提琴图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">subset</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">subset</span> <span class="cm-operator">=</span> <span class="cm-variable">nFeature_RNA</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">minGene</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">nFeature_RNA</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">maxGene</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">nCount_RNA</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">maxUMI</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">percent.mt</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">pctMT</span> )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plots</span> <span class="cm-operator">=</span> <span class="cm-builtin">list</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-variable">seq_along</span>(<span class="cm-variable">plot.featrures</span>)){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plots</span>[[<span class="cm-variable">i</span>]] <span class="cm-operator">=</span> <span class="cm-variable">VlnPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-variable">group</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">0.01</span>,<span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">plot.featrures</span>[<span class="cm-variable">i</span>]) <span class="cm-operator">+</span> <span class="cm-variable">theme.set2</span> <span class="cm-operator">+</span><span class="cm-variable">NoLegend</span>()}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">violin</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">wrap_plots</span>(<span class="cm-variable">plots</span> <span class="cm-operator">=</span> <span class="cm-variable">plots</span>, <span class="cm-variable">nrow</span><span class="cm-operator">=</span><span class="cm-number">1</span>) &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"QC/vlnplot_after_qc.pdf"</span>, <span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">violin</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">9</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 330px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><p><img src="images/2021-10-24-21-53-23.png" referrerpolicy="no-referrer">
<span>关于核糖体和红细胞的质控根据需求选择是否需要，若需要，在上一步代码添加新的质控指标。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 计算细胞中核糖体基因比例</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pbmc</span>[[<span class="cm-string">"percent.rb"</span>]] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">PercentageFeatureSet</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">pattern</span> <span class="cm-operator">=</span> <span class="cm-string">"^RP[LS]"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 计算红细胞比例，检测是否有被血污染</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">HB.genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">c</span>(<span class="cm-string">"HBA1"</span>,<span class="cm-string">"HBA2"</span>,<span class="cm-string">"HBB"</span>,<span class="cm-string">"HBD"</span>,<span class="cm-string">"HBE1"</span>,<span class="cm-string">"HBG1"</span>,<span class="cm-string">"HBG2"</span>,<span class="cm-string">"HBM"</span>,<span class="cm-string">"HBQ1"</span>,<span class="cm-string">"HBZ"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">HB.genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CaseMatch</span>(<span class="cm-variable">HB.genes</span>, <span class="cm-variable">rownames</span>(<span class="cm-variable">pbmc</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pbmc</span>[[<span class="cm-string">"percent.HB"</span>]]<span class="cm-operator cm-arrow">&lt;-</span><span class="cm-variable">PercentageFeatureSet</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span><span class="cm-operator">=</span><span class="cm-variable">HB.genes</span>) </span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><blockquote><p><span>检测doublets</span></p></blockquote><ul><li><span>Doublets：单个液滴(droplet)捕获一个条形码珠(barcode bead)和多个细胞核，导致了异常高的基因计数。</span></li><li><mark><span>！！！</span></mark><span>一般来说，建议检测doublets在QC的质控nFeature_RNA步骤之前，先去除异常高的基因计数对后续QC效果更好。且一般在聚类步骤或者细胞类型注释之后去除doublets效果更好，因为这样能从图中清楚看到哪一些细胞是在簇的边缘和属于哪一类的细胞，而这一些边缘的细胞一般来说是doublets。</span></li><li><mark><span>去除doublets之后，再对其余的原始counts矩阵进行新一轮的Seurat的标准分析流程。</span></mark></li></ul><ol start='' ><li><span>DoubletFinder包</span>
<em><span>（与Seurat的交互：在seurat标准流程进行到t-SNE和UMAP降维之后，FindAllMarkers之前进行DoubletFinder操作。）</span></em></li></ol><p><span>原理：从现有的矩阵的细胞中根据我们预先定义好的细胞类型模拟一些双细胞出来（比如单核和T细胞的双细胞、B细胞和中性粒细胞的双细胞等等），将模拟出的双细胞和原有矩阵的细胞混合在一起，进行降维聚类，原则上人工模拟的doublets会与真实的doublets距离较近，因此计算每个细胞K最近邻细胞中人工模拟doublets的比例 (pANN)，就可以根据pANN值对每个barcode的doublets概率进行排序。另外依据泊松分布的统计原理可以计算每个样本中doublets的数量，结合之前的细胞pANN值排序，就可以过滤doublets了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">devtools</span><span class="cm-operator">::</span><span class="cm-variable">install_github</span>(<span class="cm-string">'chris-mcginnis-ucsf/DoubletFinder'</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">DoubletFinder</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">## 检测doublets</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pc.num</span><span class="cm-operator">=</span><span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 寻找最优pK值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">sweep.res.list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">paramSweep_v3</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">PCs</span> <span class="cm-operator">=</span> <span class="cm-variable">pc.num</span>, <span class="cm-variable">sct</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>) <span class="cm-comment">#使用log标准化，sct参数设置为 sct = F（默认 ）,如使用SCT标准化方法，设置为T</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">saveRDS</span>(<span class="cm-variable">sweep.res.list</span>, <span class="cm-string">"QC/sweep.res.list.rds"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 当GT设置为 TRUE时，可用于ROC分析。 默认设置为 FALSE。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">sweep.stats</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">summarizeSweep</span>(<span class="cm-variable">sweep.res.list</span>, <span class="cm-variable">GT</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>) &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bcmvn</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">find.pK</span>(<span class="cm-variable">sweep.stats</span>) <span class="cm-comment">#可以看到最佳参数的点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 提取最佳pk值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pK_bcmvn</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">bcmvn</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">pK</span>[<span class="cm-variable">which.max</span>(<span class="cm-variable">bcmvn</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">BCmetric</span>)] <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">as.character</span>() <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">as.numeric</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 排除不能检出的同源doublets，优化期望的doublets数量，双细胞有两种，同源双细胞和异源双细胞。DoubletFinder只能检测异源双细胞。所以需要把同源双细胞可能的比率去除掉，以优化期望的doublets数量。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 按每增加1000个细胞，双细胞比率增加千分之8来计算 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DoubletRate</span> <span class="cm-operator">=</span> <span class="cm-variable">ncol</span>(<span class="cm-variable">pbmc</span>)<span class="cm-operator">*</span><span class="cm-number">8</span><span class="cm-operator">*</span><span class="cm-number">1e-6</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 估计同源双细胞比例，根据modelHomotypic()中的参数为人为混合双细胞。这里是从seurat_clusters中来混双细胞 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">homotypic.prop</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">modelHomotypic</span>(<span class="cm-variable">pbmc</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SingleR</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 该部分使用SingleR后的数据是为了可视化哪些类型的细胞中有doublets </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">nExp_poi</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">round</span>(<span class="cm-variable">DoubletRate</span><span class="cm-operator">*</span><span class="cm-variable">ncol</span>(<span class="cm-variable">pbmc</span>)) &nbsp;<span class="cm-comment"># 计算双细胞比例</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">nExp_poi.adj</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">round</span>(<span class="cm-variable">nExp_poi</span><span class="cm-operator">*</span>(<span class="cm-number">1</span><span class="cm-operator">-</span><span class="cm-variable">homotypic.prop</span>)) &nbsp;<span class="cm-comment"># 使用同源双细胞比例对计算的双细胞比例进行校正</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># 使用确定好的参数鉴定doublets</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">doubletFinder_v3</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">PCs</span> <span class="cm-operator">=</span> <span class="cm-variable">pc.num</span>, <span class="cm-variable">pN</span> <span class="cm-operator">=</span> <span class="cm-number">0.25</span>, <span class="cm-variable">pK</span> <span class="cm-operator">=</span> <span class="cm-variable">pK_bcmvn</span>, <span class="cm-variable">nExp</span> <span class="cm-operator">=</span> <span class="cm-variable">nExp_poi.adj</span>, <span class="cm-variable">reuse.pANN</span> <span class="cm-operator">=</span> <span class="cm-variable">F</span>, <span class="cm-variable">sct</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 可视化结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">names</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>) <span class="cm-operator">=</span> <span class="cm-variable">gsub</span>(<span class="cm-string">"DF.classifications.*"</span>, <span class="cm-string">"DF.classifications"</span>, <span class="cm-variable">colnames</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>)) &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-string">"DF.classifications"</span>) <span class="cm-operator">+</span> <span class="cm-variable">scale_color_manual</span>(<span class="cm-variable">values</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"red"</span>, <span class="cm-string">"gray"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">p1</span><span class="cm-operator">|</span><span class="cm-variable">p2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ggsave</span>(<span class="cm-string">"QC/Doublets_DFpred.pdf"</span>, <span class="cm-variable">p</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">12</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 770px;"></div><div class="CodeMirror-gutters" style="display: none; height: 770px;"></div></div></div></pre><p><img src="images/2021-10-24-21-59-08.png" referrerpolicy="no-referrer">
<br></p><ol start='2' ><li><span>Scrublet包(python)</span>
<span>原理：给定一个原始的（未归一化的）UMI矩阵，以细胞为行，基因为列的矩阵counts_matrix计数，计算每个单元的多细胞得分。</span></li></ol><blockquote><p><span>注意事项：</span></p></blockquote><ol start='' ><li><span>处理来自多个样本的数据时，请分别对每个样本运行Scrublet。 因为Scrublet旨在检测由两个细胞的随机共封装形成的technical doublets，所以在merged数据集上可能会表现不佳，因为细胞类型比例不代表任何单个样品； </span></li><li><span>检查doublet score阈值是否合理，并在必要时进行手动调整。并不是所有情况向下doublet score的直方分布图都是呈现标准的双峰； </span></li><li><span>UMAP或t-SNE可视化的结果中，预测的双细胞应该大体上共定位（可能在多个细胞群中）。如果不是，则可能需要调整doublet score阈值，或更改预处理参数以更好地解析数据中存在的细胞状态。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">scrublet</span> <span class="cm-keyword">as</span> <span class="cm-variable">scr</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">scipy</span>.<span class="cm-property">io</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">matplotlib</span>.<span class="cm-property">pyplot</span> <span class="cm-keyword">as</span> <span class="cm-variable">plt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">numpy</span> <span class="cm-keyword">as</span> <span class="cm-variable">np</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pandas</span> <span class="cm-keyword">as</span> <span class="cm-variable">pd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">input_dir</span> <span class="cm-operator">=</span> <span class="cm-string">'.../pbmc3k_filtered_gene_bc_matrices/filtered_gene_bc_matrices/hg19'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">counts_matrix</span> <span class="cm-operator">=</span> <span class="cm-variable">scipy</span>.<span class="cm-property">io</span>.<span class="cm-property">mmread</span>(<span class="cm-variable">input_dir</span> <span class="cm-operator">+</span> <span class="cm-string">'/matrix.mtx'</span>).<span class="cm-property">T</span>.<span class="cm-property">tocsc</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">genes</span> <span class="cm-operator">=</span> <span class="cm-variable">np</span>.<span class="cm-property">array</span>(<span class="cm-variable">scr</span>.<span class="cm-property">load_genes</span>(<span class="cm-variable">input_dir</span> <span class="cm-operator">+</span> <span class="cm-string">'/genes.tsv'</span>, <span class="cm-variable">delimiter</span><span class="cm-operator">=</span><span class="cm-string">'\t'</span>, <span class="cm-variable">column</span><span class="cm-operator">=</span><span class="cm-number">1</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">out_df</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">read_csv</span>(<span class="cm-variable">input_dir</span> <span class="cm-operator">+</span> <span class="cm-string">'/barcodes.tsv'</span>, <span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-keyword">None</span>, <span class="cm-variable">index_col</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>, <span class="cm-variable">names</span><span class="cm-operator">=</span>[<span class="cm-string">'barcode'</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化Scrublet对象，expected_doublet_rate通常为0.05-0.1，结果对该参数不敏感</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scrub</span> <span class="cm-operator">=</span> <span class="cm-variable">scr</span>.<span class="cm-property">Scrublet</span>(<span class="cm-variable">counts_matrix</span>, <span class="cm-variable">expected_doublet_rate</span><span class="cm-operator">=</span><span class="cm-number">0.06</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 计算doublet score</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">doublet_scores</span>, <span class="cm-variable">predicted_doublets</span> <span class="cm-operator">=</span> <span class="cm-variable">scrub</span>.<span class="cm-property">scrub_doublets</span>(<span class="cm-variable">min_counts</span><span class="cm-operator">=</span><span class="cm-number">2</span>, <span class="cm-variable">min_cells</span><span class="cm-operator">=</span><span class="cm-number">3</span>, <span class="cm-variable">min_gene_variability_pctl</span><span class="cm-operator">=</span><span class="cm-number">85</span>, <span class="cm-variable">n_prin_comps</span><span class="cm-operator">=</span><span class="cm-number">30</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><p><img src="images/2021-10-24-22-00-53.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 绘制doublet score分布直方图</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scrub</span>.<span class="cm-property">call_doublets</span>(<span class="cm-variable">threshold</span><span class="cm-operator">=</span><span class="cm-number">0.30</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如果自动阈值检测效果不佳，则可以使用call_doublets()函数调整阈值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Doublet score分布直方图包括观察到的转录组和模拟的doublet，模拟的doublet直方图通常是双峰的。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 画doublet score直方图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scrub</span>.<span class="cm-property">plot_histogram</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### 理想情况下，阈值应在模拟doublet直方图的两种模式之间设置最小值</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><img src="images/2021-10-24-22-01-34.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 降维可视化</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">'Running UMAP...'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scrub</span>.<span class="cm-property">set_embedding</span>(<span class="cm-string">'UMAP'</span>, <span class="cm-variable">scr</span>.<span class="cm-property">get_umap</span>(<span class="cm-variable">scrub</span>.<span class="cm-property">manifold_obs_</span>, <span class="cm-number">10</span>, <span class="cm-variable">min_dist</span><span class="cm-operator">=</span><span class="cm-number">0.3</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">'Done.'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### UMAP可视化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scrub</span>.<span class="cm-property">plot_embedding</span>(<span class="cm-string">'UMAP'</span>, <span class="cm-variable">order_points</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><p><img src="images/2021-10-24-22-02-01.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># doublets占比</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span> (<span class="cm-variable">scrub</span>.<span class="cm-property">detected_doublet_rate_</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 0.014074074074074074</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 把doublets预测结果保存到文件，后续用Seurat等软件处理的时候可以导入doublets的预测结果对barcode进行筛选。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">out_df</span>[<span class="cm-string">'doublet_scores'</span>] <span class="cm-operator">=</span> <span class="cm-variable">doublet_scores</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">out_df</span>[<span class="cm-string">'predicted_doublets'</span>] <span class="cm-operator">=</span> <span class="cm-variable">predicted_doublets</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">out_df</span>.<span class="cm-property">to_csv</span>(<span class="cm-variable">input_dir</span> <span class="cm-operator">+</span> <span class="cm-string">'/doublet.txt'</span>, <span class="cm-variable">index</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>,<span class="cm-variable">header</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">out_df</span>.<span class="cm-property">head</span>()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><img src="images/2021-10-24-22-03-01.png" referrerpolicy="no-referrer"></p><h3 id='归一化数据'><span>归一化数据</span></h3><p><span>我们采用</span><mark><span>全局缩放归一化方法“LogNormalize”</span></mark><span>，该方法将每个细胞的特征表达式测量值与总表达式进行归一化，乘以一个比例因子（默认为 10,000），并对结果进行对数转换。将有量纲的表达式，经过变换，化为无量纲的表达式，标准化值存储在</span><code>pbmc[[&quot;RNA&quot;]]@data</code><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">normalization.method</span> <span class="cm-operator">=</span> <span class="cm-string">"LogNormalize"</span>, <span class="cm-variable">scale.factor</span> <span class="cm-operator">=</span> <span class="cm-number">10000</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><h3 id='识别高可变基因'><span>识别高可变基因</span></h3><ul><li><span>高可变基因：在某些细胞中高度表达，而在其他细胞中表达低（在下游分析中关注这些基因有助于突出单细胞数据集中的生物信号。）</span></li><li><span>使用均值与方差之间的关系，来挑选高变基因，默认返回前2000个高变基因进入下游分析，如PCA。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindVariableFeatures</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">selection.method</span> <span class="cm-operator">=</span> <span class="cm-string">"vst"</span>, <span class="cm-variable">nfeatures</span> <span class="cm-operator">=</span> <span class="cm-number">2000</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Identify the 10 most highly variable genes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">top10</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">head</span>(<span class="cm-variable">VariableFeatures</span>(<span class="cm-variable">pbmc</span>), <span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># plot variable features with and without labels</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">VariableFeaturePlot</span>(<span class="cm-variable">pbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">LabelPoints</span>(<span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">plot1</span>, <span class="cm-variable">points</span> <span class="cm-operator">=</span> <span class="cm-variable">top10</span>, <span class="cm-variable">repel</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot1</span> <span class="cm-operator">+</span> <span class="cm-variable">plot2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><img src="images/2021-10-24-22-06-46.png" referrerpolicy="no-referrer"></p><h3 id='标准化数据'><span>标准化数据</span></h3><p><span>在降维技术（如 PCA）之前的标准预处理步骤，使用ScaleData()函数，使数据符合标准正态分布，因为PCA分析默认数据是服从正态分布，其结果存储在pbmc[[&quot;RNA&quot;]]@scale.data。</span>
<span>ScaleData()函数：</span></p><ul><li><span>改变每个基因的表达，使跨细胞的平均表达为 0</span></li><li><span>缩放每个基因的表达，使细胞间的方差为 1</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">all.genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">pbmc</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">all.genes</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><blockquote><p><span>SCTransform()函数</span></p></blockquote><p><mark><span>可以代替以上三个处理步骤的函数（NormalizeData,</span>
<span>ScaleData,FindVariableFeatures）的运行。</span></mark><span>这是一个用方差稳定变换对单细胞UMI count 数据标准化的方法，方差稳定变换是基于负二项回归。这个函数在对数据进行均一化的同时还可以去除线粒体红细胞等混杂因素的影响。</span>
<span>优点：</span></p><ul><li><span>对测序深度的校正效果要好于log归一化。（10万以内的细胞都建议使用SCT标准化）</span></li><li><span>SCTransform对测序深度的校正效果很好，也可用于校正线粒体等因素的影响，但不能用于批次校正。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">pbmc</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">FindVariableFeatures</span>(<span class="cm-variable">nfeatures</span> <span class="cm-operator">=</span> <span class="cm-number">2000</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">vars.to.regress</span> <span class="cm-operator">=</span> <span class="cm-string">"percent.mt"</span>))</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SCTransform</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">vars.to.regress</span> <span class="cm-operator">=</span> <span class="cm-string">"percent.mt"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><span>以上两行代码功能相同。</span></p><h3 id='执行线性降维'><span>执行线性降维</span></h3><ol start='' ><li><span>PCA主成分分析</span>
<span>接下来，我们对标准化后的数据进行PCA分析。默认的，只是用前面决定的高变基因进行PCA分析，也可以使用features参数设置用户自己选择的基因进行PCA分析。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">VariableFeatures</span>(<span class="cm-variable">object</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc</span>))</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Examine and visualize PCA results a few different ways</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">print</span>(<span class="cm-variable">pbmc</span>[[<span class="cm-string">"pca"</span>]], <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">5</span>, <span class="cm-variable">nfeatures</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">VizDimLoadings</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">2</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"pca"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"pca"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p><img src="images/2021-10-24-22-13-00.png" referrerpolicy="no-referrer">
<img src="images/2021-10-24-22-13-18.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### DimHeatmap()允许我们探索数据中的最初的异质性，然后决定下游使用多少个PC进行分析。</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimHeatmap</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">cells</span> <span class="cm-operator">=</span> <span class="cm-number">500</span>, <span class="cm-variable">balanced</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimHeatmap</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">15</span>, <span class="cm-variable">cells</span> <span class="cm-operator">=</span> <span class="cm-number">500</span>, <span class="cm-variable">balanced</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p><img src="images/2021-10-24-22-13-39.png" referrerpolicy="no-referrer"></p><ol start='2' ><li><span>NMF非负矩阵分解</span></li></ol><p><mark><span>（一般在PCA后再使用NMF，使得因子解释性更高）</span></mark>
<br><span>* 矩阵分解的方法有很多种，如奇异值分解 (singular value decomposition, SVD) 、独立成分分析 (independent component analysis, ICA) 、主成分分析 (principal component analysis, PCA) 等。这些方法的共同特点是，即使初始矩阵V元素是非负的，分解出来的因子 W 和 H 中的元素往往含有负值元素。从计算科学的角度来看，分解出来的因子 W 和 H 中的元素含有负值元素并没有问题， 但负值元素通常是无法解释的。</span>
<br><span>* 非负矩阵分解(Non-negative Matrix Factorization, NMF)本质上说是一种矩阵分解的方法，最重要的特点是非负性约束,对于任意给定的一个非负矩阵V，NMF算法能够寻找到一个非负矩阵W和一个非负矩阵H，使得 V≈W</span><em><span>H成立 ，从而将一个非负的矩阵分解为左右两个非负矩阵的乘积。</span>
<br></em><span> 相比于PCA的优势：虽然NMF运行的时间比PCA时间更长，但它分解的因子很容易与细胞类型或表达模式对应起来，即NMF的因子可解释性更强。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### 关于NMF的函数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">nmf</span>(<span class="cm-variable">x</span>, <span class="cm-variable">rank</span>, <span class="cm-variable">method</span>, <span class="cm-variable">seed</span>, <span class="cm-variable">nrun</span>, <span class="cm-keyword">...</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">x</span>：待分解非负矩阵，数据格式可以是<span class="cm-variable">matrix</span>，<span class="cm-variable">data.frame</span>， <span class="cm-variable">ExpressionSet</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rank</span>：分解的基数量，对于单细胞数据，可以设置为期望的细胞类型数量或表达模式数量</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">method</span>：因式分解的常用方法，这里介绍三种常用的</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">1</span>、基于<span class="cm-variable">KL</span> 散度进行度量目标函数的多重迭代梯度下降算法——<span class="cm-variable">brunet</span>(默认算法)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">2</span>、基于欧几里得距离度量目标函数的多重迭代梯度下降算法——<span class="cm-variable">lee</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">3</span>、交替最小二乘法(<span class="cm-variable">Alternating</span> <span class="cm-variable">Least</span> <span class="cm-variable">Squares</span>(<span class="cm-variable">ALS</span>))——<span class="cm-variable">snmf</span><span class="cm-operator">/</span><span class="cm-variable">r</span> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">seed</span>：因式分解的初始化种子 &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">nrun</span>：运行次数 </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">运行代码：</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 安装NMF基础包</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">BiocManager</span><span class="cm-operator">::</span><span class="cm-variable">install</span>(<span class="cm-string">'Biobase'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">install.packages</span>(<span class="cm-string">'NMF'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">tidyverse</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">NMF</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rm</span>(<span class="cm-builtin">list</span> <span class="cm-operator">=</span> <span class="cm-variable">ls</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">pbmc</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">FindVariableFeatures</span>() <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">do.center</span> <span class="cm-operator">=</span> <span class="cm-variable">F</span>)<span class="cm-comment">###重新进行标准化和归一化，设置do.center = F可以不会出现负值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">vm</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">RNA</span>@<span class="cm-variable">scale.data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">saveRDS</span>(<span class="cm-variable">vm</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"pbmc_vm.rds"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">nmf</span>(<span class="cm-variable">vm</span>, <span class="cm-number">12</span>, <span class="cm-variable">method</span> <span class="cm-operator">=</span> <span class="cm-string">"snmf/r"</span>)<span class="cm-comment">#很慢，rank值选择比目的预期的细胞类型/细胞状态稍大的值，因为分解的一些因子回复即到线粒体核糖体等噪音，而不会落到一个具体的细胞亚群上</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">save</span>(<span class="cm-variable">res</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"pbmc_nmf_res.rda"</span> )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## 分解结果返回suerat对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">nmf</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">pca</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">nmf</span>@<span class="cm-variable">cell.embeddings</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">t</span>(<span class="cm-variable">coef</span>(<span class="cm-variable">res</span>)) &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">nmf</span>@<span class="cm-variable">feature.loadings</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">basis</span>(<span class="cm-variable">res</span>) &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 提取分解得到的每个因子</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#每个因子提取30个</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fs</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">extractFeatures</span>(<span class="cm-variable">res</span>, <span class="cm-number">30L</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fs</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">fs</span>, <span class="cm-keyword">function</span>(<span class="cm-variable">x</span>) <span class="cm-variable">rownames</span>(<span class="cm-variable">res</span>)[<span class="cm-variable">x</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fs</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">do.call</span>(<span class="cm-string">"rbind"</span>, <span class="cm-variable">fs</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rownames</span>(<span class="cm-variable">fs</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">paste0</span>(<span class="cm-string">"cluster"</span>, <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">12</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">write.csv</span>(<span class="cm-variable">t</span>(<span class="cm-variable">fs</span>), <span class="cm-string">"NMF_TopGenes. csv"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DT</span><span class="cm-operator">::</span><span class="cm-variable">datatable</span>(<span class="cm-variable">t</span>(<span class="cm-variable">fs</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 选择用于后续分析的因子，使用NMF运行的结果进行降维聚类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###选择用于后续分析的因子</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">s.f</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">12</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#因子1主要是线粒体和核糖体</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##降维</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cell1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">colnames</span>(<span class="cm-variable">pbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cel12</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">colnames</span>(<span class="cm-variable">coef</span>(<span class="cm-variable">res</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cells</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">intersect</span>(<span class="cm-variable">cell1</span>, <span class="cm-variable">cel12</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span><span class="cm-operator cm-arrow">&lt;&lt;-</span><span class="cm-variable">pbmc</span>[,<span class="cm-variable">cells</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">pbmc</span>,<span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">F</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">nmf</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">pca</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">nmf</span>@<span class="cm-variable">cell.embeddings</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">t</span>(<span class="cm-variable">coef</span>(<span class="cm-variable">res</span>)[,<span class="cm-variable">cells</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span> <span class="cm-operator cm-dollar">$</span><span class="cm-variable">nmf</span>@<span class="cm-variable">feature.loadings</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">basis</span>(<span class="cm-variable">res</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunUMAP</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span><span class="cm-operator">=</span> <span class="cm-string">'nmf'</span>,<span class="cm-variable">dims</span><span class="cm-operator">=</span><span class="cm-variable">s.f</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##基于NMF降维矩阵的聚类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindNeighbors</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span><span class="cm-operator">=</span> <span class="cm-string">'nmf'</span>, <span class="cm-variable">dims</span><span class="cm-operator">=</span><span class="cm-variable">s.f</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">FindClusters</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##基于因子最大载荷分类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">cluster</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">apply</span>(<span class="cm-variable">NMF</span><span class="cm-operator">::</span><span class="cm-variable">coefficients</span>(<span class="cm-variable">res</span>)[<span class="cm-variable">s.f</span>,], <span class="cm-number">2</span>,<span class="cm-variable">which.max</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 降维聚类结果可视化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>) <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"Clustered by Louvain"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-string">"cluster"</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>) <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"Clustered by maxloading"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">p1</span><span class="cm-operator">|</span><span class="cm-variable">p2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"</span> <span class="cm-string">pbmc_NMF_Cluster.pdf"</span>, <span class="cm-variable">pc</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1430px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1430px;"></div></div></div></pre><h3 id='确定数据集的维度'><span>确定数据集的“维度”</span></h3><p><span>为了克服 scRNA-seq 数据的任何单个特征中的广泛技术噪音，Seurat 根据其 PCA 分数对细胞进行聚类，每个 PC 基本上代表一个“综合特征”，该“综合特征”组合了相关特征集的信息。因此，顶部主成分代表数据集的稳健压缩的信息。但是，我们应该选择多少个PC进行分析？</span></p><ol start='' ><li><span>JackStraw 程序启发的重采样测试。我们随机置换数据的一个子集（默认为 1%）并重新运行 PCA，构建特征分数的“零分布”，并重复此过程。我们将“显着”PC 识别为那些具有大量低 p 值特征的 PC。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># NOTE: This process can take a long time for big datasets, comment out for expediency. More</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># approximate techniques such as those implemented in ElbowPlot() can be used to reduce</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># computation time</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">JackStraw</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">num.replicate</span> <span class="cm-operator">=</span> <span class="cm-number">100</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScoreJackStraw</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">20</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><ol start='2' ><li><span>该JackStrawPlot()函数提供了一个可视化工具，用于将每个 PC 的 p 值分布与均匀分布（虚线）进行比较。“显著”PC 将显示出大量具有低 p 值的特征（虚线上方的实线）。在这种情况下，在前 10-12 个 PC 之后，重要性似乎急剧下降。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">JackStrawPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">15</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><img src="images/2021-10-24-22-18-04.png" referrerpolicy="no-referrer"></p><ol start='3' ><li><span>肘图（碎石图）：基于每个（ElbowPlot()函数）解释的方差百分比对主成分进行排名。在这个例子中，我们可以观察到 PC9-10 周围的“肘部”，这表明大部分真实信号是在前 10 个 PC 中捕获的。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ElbowPlot</span>(<span class="cm-variable">pbmc</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><img src="images/2021-10-24-22-18-34.png" referrerpolicy="no-referrer"></p><h3 id='细胞周期评分和回归选择'><span>细胞周期评分和回归(选择)</span></h3><ol start='' ><li><span>分配细胞周期分数</span>
<mark><span>如何通过基于规范标记计算细胞周期阶段分数并在预处理期间将这些从数据中回归来减轻 scRNA-seq 数据中细胞周期异质性的影响。</span></mark>
<span>在小鼠造血祖细胞数据集上演示了这一点（</span><a href='http://www.bloodjournal.org/content/early/2016/06/30/blood-2016-05-716480?sso-checked=true'><span>Nestorowa</span><em><span>等人</span></em><span>，Blood 2016 ）。可以在</span></a><a href='https://www.dropbox.com/s/3dby3bjsaf5arrw/cell_cycle_vignette_files.zip?dl=1'><span>此处</span></a><span>下载运行此小插曲所需的文件。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Read in the expression matrix The first row is a header row, the first column is rownames</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">exp.mat</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.table</span>(<span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"../data/nestorawa_forcellcycle_expressionMatrix.txt"</span>, <span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">as.is</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>, <span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># A list of cell cycle markers, from Tirosh et al, 2015, is loaded with Seurat.  We can</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># segregate this list into markers of G2/M phase and markers of S phase</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">s.genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cc.genes</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">s.genes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">g2m.genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cc.genes</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">g2m.genes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Create our Seurat object and complete the initalization steps</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateSeuratObject</span>(<span class="cm-variable">counts</span> <span class="cm-operator">=</span> <span class="cm-variable">exp.mat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">marrow</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindVariableFeatures</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">selection.method</span> <span class="cm-operator">=</span> <span class="cm-string">"vst"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">marrow</span>))</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 418px;"></div><div class="CodeMirror-gutters" style="display: none; height: 418px;"></div></div></div></pre><p><span>如果我们在我们的Seuratobject上运行 PCA，使用我们在上面找到的可变基因</span><code>[FindVariableFeatures()](https://satijalab.org/seurat/reference/FindVariableFeatures.html)</code><span>，我们会看到虽然大多数差异可以用谱系来解释，但 PC8 和 PC10 在包括</span><em><span>TOP2A</span></em><span>和</span><em><span>MKI67</span></em><span>在内的细胞周期基因上分裂。我们将尝试从数据中回归此信号，以便细胞周期异质性不会有助于 PCA 或下游分析。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">VariableFeatures</span>(<span class="cm-variable">marrow</span>), <span class="cm-variable">ndims.print</span> <span class="cm-operator">=</span> <span class="cm-number">6</span><span class="cm-operator">:</span><span class="cm-number">10</span>, <span class="cm-variable">nfeatures.print</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimHeatmap</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-number">8</span>, <span class="cm-number">10</span>))</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p><img src="images/justification-1.png" referrerpolicy="no-referrer"></p><p><span>首先，我们</span><mark><span>根据其 G2/M 和 S 期标记的表达为每个细胞分配一个分数。</span></mark><span>这些标记组的表达水平应该是反相关的，表达两者的细胞可能不会循环并处于 G1 期。</span>
<span>我们在函数中分配分数，该</span><code>[CellCycleScoring()](https://satijalab.org/seurat/reference/CellCycleScoring.html)</code><span>函数将 S 和 G2/M 分数存储在对象元数据中，以及每个细胞在 G2M、S 或 G1 阶段的预测分类。</span><code>[CellCycleScoring()](https://satijalab.org/seurat/reference/CellCycleScoring.html)</code><span>还可以通过传递将Seurat对象的身份设置为细胞周期阶段</span><code>set.ident = TRUE</code><span>（原始身份存储为</span><code>old.ident</code><span>）。请注意，Seurat 在下游细胞周期回归中不使用离散分类 (G2M/G1/S)。相反，它使用 G2M 和 S 阶段的定量分数。但是，如果我们感兴趣，我们会提供我们的预测分类。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CellCycleScoring</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">s.features</span> <span class="cm-operator">=</span> <span class="cm-variable">s.genes</span>, <span class="cm-variable">g2m.features</span> <span class="cm-operator">=</span> <span class="cm-variable">g2m.genes</span>, <span class="cm-variable">set.ident</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># view cell cycle scores and phase assignments</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">marrow</span>[[]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Visualize the distribution of cell cycle markers across</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">RidgePlot</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"PCNA"</span>, <span class="cm-string">"TOP2A"</span>, <span class="cm-string">"MCM6"</span>, <span class="cm-string">"MKI67"</span>), <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><img src="images/cc_score-1.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Running a PCA on cell cycle genes reveals, unsurprisingly, that cells separate entirely by</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># phase</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-variable">s.genes</span>, <span class="cm-variable">g2m.genes</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">marrow</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p><img src="images/cc_score-2.png" referrerpolicy="no-referrer"></p><ol start='2' ><li><span>在数据缩放期间回归细胞周期分数</span>
<span>现在尝试从数据中减去（“回归”）这种异质性来源。对于 Seurat v1.4 的用户，这是在</span><code>RegressOut</code><span>. 但是，由于此过程的结果存储在缩放的数据槽中（因此会覆盖 的输出</span><code>[ScaleData()](https://satijalab.org/seurat/reference/ScaleData.html)</code><span>），我们现在将此功能合并到</span><code>[ScaleData()](https://satijalab.org/seurat/reference/ScaleData.html)</code><span>函数本身中。</span>
<mark><span>对于每个基因，Seurat 模拟了基因表达与 S 和 G2M 细胞周期评分之间的关​​系。该模型的缩放残差代表一个“校正的”表达矩阵，可用于下游降维。</span></mark></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">vars.to.regress</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"S.Score"</span>, <span class="cm-string">"G2M.Score"</span>), <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">marrow</span>))</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Now, a PCA on the variable genes no longer returns components associated with cell cycle</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">VariableFeatures</span>(<span class="cm-variable">marrow</span>), <span class="cm-variable">nfeatures.print</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># When running a PCA on only cell cycle genes, cells no longer separate by cell-cycle phase</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-variable">s.genes</span>, <span class="cm-variable">g2m.genes</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">marrow</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p><img src="images/pca3-1.png" referrerpolicy="no-referrer"></p><ol start='3' ><li><span>备用工作流程</span>
<span>上述程序删除了与细胞周期相关的所有信号。</span><strong><span>在某些情况下，我们发现这会对下游分析产生负面影响，尤其是在干细胞处于静止状态而分化细胞正在增殖（反之亦然）的分化过程（如小鼠造血）中。</span></strong><span> </span><em><span>在这种情况下，消除所有细胞周期效应也会模糊干细胞和祖细胞之间的区别。</span></em>
<mark><span>作为替代方案，我们建议回归G2M 和 S 阶段分数之间的</span><strong><span>差异。</span></strong></mark><span>这意味着将保持分离非循环细胞和循环细胞的信号，但增殖细胞之间的细胞周期阶段差异（通常是无趣的）将从数据中回归。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">CC.Difference</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">marrow</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">S.Score</span> <span class="cm-operator">-</span> <span class="cm-variable">marrow</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">G2M.Score</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">vars.to.regress</span> <span class="cm-operator">=</span> <span class="cm-string">"CC.Difference"</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">marrow</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># cell cycle effects strongly mitigated in PCA</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">VariableFeatures</span>(<span class="cm-variable">marrow</span>), <span class="cm-variable">nfeatures.print</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># when running a PCA on cell cycle genes, actively proliferating cells remain distinct from G1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># cells however, within actively proliferating cells, G2M and S phase cells group together</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marrow</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">marrow</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-variable">s.genes</span>, <span class="cm-variable">g2m.genes</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">marrow</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><p><img src="images/pca5-1.png" referrerpolicy="no-referrer"></p><h2 id='整合多个scrna-seq数据集'><span>整合多个scRNA-seq数据集</span></h2><hr /><h4 id='与seurat标准处理流程一致'><span>与seurat标准处理流程一致</span></h4><p><mark><span>两个或多个单细胞数据集的联合分析。</span></mark><span>在标准工作流程下，识别存在于多个数据集中的细胞群可能会出现问题。Seurat v4 包括一组方法来匹配（或“对齐”）跨数据集的共享细胞群。这些方法首先识别处于匹配生物学状态（“锚”）的跨数据集细胞对，既可用于校正数据集之间的技术差异（即批量效应校正），也可用于进行比较的 scRNA-seq 分析跨实验条件。</span></p><p><span>我们展示了</span><a href='https://www.cell.com/cell/fulltext/S0092-8674(19)30559-8'><span>Stuart</span><em><span>、Butler</span></em><span> 等人 2019 年</span></a><span>所述的 scRNA-seq 整合方法，以对处于</span><a href='https://www.nature.com/articles/nbt.4042'><span>静息或干扰素刺激状态</span></a><span>的人类免疫细胞 (PBMC) 进行比较分析。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Setup the Seurat objects</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">SeuratData</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">patchwork</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># load dataset</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">LoadData</span>(<span class="cm-string">"ifnb"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># load seurat data(a sample)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dir</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">dir</span>(<span class="cm-string">"data/"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dir</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">paste0</span>(<span class="cm-string">"data/"</span>, <span class="cm-variable">dir</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">samples_name</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">'ctrl'</span>, <span class="cm-string">'stim'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##使用循环命令批量创建seurat对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scRNAlist</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-builtin">list</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-variable">length</span>(<span class="cm-variable">dir</span>)){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Insufficient data values to produce 24 bins.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">counts</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Read10X</span>(<span class="cm-variable">data.dir</span> <span class="cm-operator">=</span> <span class="cm-variable">dir</span>[<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scRNAlist</span>[[<span class="cm-variable">i</span>]] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Read10X</span>(<span class="cm-variable">data.dir</span> <span class="cm-operator">=</span> <span class="cm-variable">dir</span>[<span class="cm-variable">i</span>]) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">CreateSeuratObject</span>(<span class="cm-variable">project</span><span class="cm-operator">=</span><span class="cm-variable">samples_name</span>[<span class="cm-variable">i</span>],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">#min.cells=3,#可以指定每个样本最少的细胞数目</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">min.features</span> <span class="cm-operator">=</span> <span class="cm-number">100</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#给细胞barcode加个前缀，防止合并后barcode重名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">scRNAlist</span>[[<span class="cm-variable">i</span>]] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RenameCells</span>(<span class="cm-variable">scRNAlist</span>[[<span class="cm-variable">i</span>]], <span class="cm-variable">add.cell.id</span> <span class="cm-operator">=</span> <span class="cm-variable">samples_name</span>[<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#给列表命名并保存数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">names</span>(<span class="cm-variable">scRNAlist</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">samples_name</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 检查合并的对象是否具有适当的特定于样本的前缀</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">scRNAlist</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">ctrl</span>@<span class="cm-variable">meta.data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">scRNAlist</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">stim</span>@<span class="cm-variable">meta.data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># split the dataset into a list of two seurat objects (stim and CTRL)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ifnb.list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SplitObject</span>(<span class="cm-variable">ifnb</span>, <span class="cm-variable">split.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># normalize and identify variable features for each dataset independently</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ifnb.list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">X</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>, <span class="cm-variable">FUN</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-variable">x</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">x</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">x</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">x</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindVariableFeatures</span>(<span class="cm-variable">x</span>, <span class="cm-variable">selection.method</span> <span class="cm-operator">=</span> <span class="cm-string">"vst"</span>, <span class="cm-variable">nfeatures</span> <span class="cm-operator">=</span> <span class="cm-number">2000</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># select features that are repeatedly variable across datasets for integration</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">features</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SelectIntegrationFeatures</span>(<span class="cm-variable">object.list</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Perform integration</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.anchors</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindIntegrationAnchors</span>(<span class="cm-variable">object.list</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>, <span class="cm-variable">anchor.features</span> <span class="cm-operator">=</span> <span class="cm-variable">features</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># this command creates an 'integrated' data assay</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">IntegrateData</span>(<span class="cm-variable">anchorset</span> <span class="cm-operator">=</span> <span class="cm-variable">immune.anchors</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Perform an integrated analysis</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># specify that we will perform downstream analysis on the corrected data note that the</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># original unmodified data still resides in the 'RNA' assay</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">immune.combined</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"integrated"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Run the standard workflow for visualization and clustering</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">npcs</span> <span class="cm-operator">=</span> <span class="cm-number">30</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunUMAP</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"pca"</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">30</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindNeighbors</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"pca"</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">30</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindClusters</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">resolution</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Visualization</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>, <span class="cm-variable">repel</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator">+</span> <span class="cm-variable">p2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1452px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1452px;"></div></div></div></pre><p><img src="images/viz-1.png" referrerpolicy="no-referrer"></p><p>&nbsp;</p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>, <span class="cm-variable">split.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><img src="images/split.dim-1.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Identify conserved cell type markers</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># For performing differential expression after integration, we switch back to the original</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">immune.combined</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"RNA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">nk.markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindConservedMarkers</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">grouping.var</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">nk.markers</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"CD3D"</span>, <span class="cm-string">"SELL"</span>, <span class="cm-string">"CREM"</span>, <span class="cm-string">"CD8A"</span>, <span class="cm-string">"GNLY"</span>, <span class="cm-string">"CD79A"</span>, <span class="cm-string">"FCGR3A"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"CCL2"</span>, <span class="cm-string">"PPBP"</span>), <span class="cm-variable">min.cutoff</span> <span class="cm-operator">=</span> <span class="cm-string">"q9"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>该步骤为了</span><mark><span>识别跨条件保守的典型细胞类型标记基因</span></mark><span>mark&gt;，我们提供了该</span><code>FindConservedMarkers()</code><span>功能。此函数对每个数据集/组执行差异基因表达测试，并使用 MetaDE R 包中的元分析方法组合 p 值。例如，我们可以计算在簇 6（NK 细胞）中无论刺激条件如何都是保守标记的基因。</span></p><p><img src="images/annotate-1.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RenameIdents</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable-3">`0`</span> <span class="cm-operator">=</span> <span class="cm-string">"CD14 Mono"</span>, <span class="cm-variable-3">`1`</span> <span class="cm-operator">=</span> <span class="cm-string">"CD4 Naive T"</span>, <span class="cm-variable-3">`2`</span> <span class="cm-operator">=</span> <span class="cm-string">"CD4 Memory T"</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">`3`</span> <span class="cm-operator">=</span> <span class="cm-string">"CD16 Mono"</span>, <span class="cm-variable-3">`4`</span> <span class="cm-operator">=</span> <span class="cm-string">"B"</span>, <span class="cm-variable-3">`5`</span> <span class="cm-operator">=</span> <span class="cm-string">"CD8 T"</span>, <span class="cm-variable-3">`6`</span> <span class="cm-operator">=</span> <span class="cm-string">"NK"</span>, <span class="cm-variable-3">`7`</span> <span class="cm-operator">=</span> <span class="cm-string">"T activated"</span>, <span class="cm-variable-3">`8`</span> <span class="cm-operator">=</span> <span class="cm-string">"DC"</span>, <span class="cm-variable-3">`9`</span> <span class="cm-operator">=</span> <span class="cm-string">"B Activated"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">`10`</span> <span class="cm-operator">=</span> <span class="cm-string">"Mk"</span>, <span class="cm-variable-3">`11`</span> <span class="cm-operator">=</span> <span class="cm-string">"pDC"</span>, <span class="cm-variable-3">`12`</span> <span class="cm-operator">=</span> <span class="cm-string">"Eryth"</span>, <span class="cm-variable-3">`13`</span> <span class="cm-operator">=</span> <span class="cm-string">"Mono/Mk Doublets"</span>, <span class="cm-variable-3">`14`</span> <span class="cm-operator">=</span> <span class="cm-string">"HSPC"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><img src="images/annotate-2.png" referrerpolicy="no-referrer"></p><p><code>DotPlot()</code><span>带有</span><code>split.by</code><span>参数的函数可用于查看跨条件的保守细胞类型标记，显示表达水平和表达任何给定基因的簇中细胞的百分比。在这里，我们为 14 个聚类中的每一个绘制了 2-3 个强标记基因。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Idents</span>(<span class="cm-variable">immune.combined</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">factor</span>(<span class="cm-variable">Idents</span>(<span class="cm-variable">immune.combined</span>), <span class="cm-variable">levels</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"HSPC"</span>, <span class="cm-string">"Mono/Mk Doublets"</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"pDC"</span>, <span class="cm-string">"Eryth"</span>, <span class="cm-string">"Mk"</span>, <span class="cm-string">"DC"</span>, <span class="cm-string">"CD14 Mono"</span>, <span class="cm-string">"CD16 Mono"</span>, <span class="cm-string">"B Activated"</span>, <span class="cm-string">"B"</span>, <span class="cm-string">"CD8 T"</span>, <span class="cm-string">"NK"</span>, <span class="cm-string">"T activated"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"CD4 Naive T"</span>, <span class="cm-string">"CD4 Memory T"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">markers.to.plot</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">c</span>(<span class="cm-string">"CD3D"</span>, <span class="cm-string">"CREM"</span>, <span class="cm-string">"HSPH1"</span>, <span class="cm-string">"SELL"</span>, <span class="cm-string">"GIMAP5"</span>, <span class="cm-string">"CACYBP"</span>, <span class="cm-string">"GNLY"</span>, <span class="cm-string">"NKG7"</span>, <span class="cm-string">"CCL5"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"CD8A"</span>, <span class="cm-string">"MS4A1"</span>, <span class="cm-string">"CD79A"</span>, <span class="cm-string">"MIR155HG"</span>, <span class="cm-string">"NME1"</span>, <span class="cm-string">"FCGR3A"</span>, <span class="cm-string">"VMO1"</span>, <span class="cm-string">"CCL2"</span>, <span class="cm-string">"S100A9"</span>, <span class="cm-string">"HLA-DQA1"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"GPR183"</span>, <span class="cm-string">"PPBP"</span>, <span class="cm-string">"GNG11"</span>, <span class="cm-string">"HBA2"</span>, <span class="cm-string">"HBB"</span>, <span class="cm-string">"TSPAN13"</span>, <span class="cm-string">"IL3RA"</span>, <span class="cm-string">"IGJ"</span>, <span class="cm-string">"PRSS57"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DotPlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">markers.to.plot</span>, <span class="cm-variable">cols</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"blue"</span>, <span class="cm-string">"red"</span>), <span class="cm-variable">dot.scale</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>, <span class="cm-variable">split.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">RotatedAxis</span>()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><p><img src="images/splitdotplot-1.png" referrerpolicy="no-referrer"></p><ul><li><span>跨条件识别差异表达基因</span></li></ul><p><span>现在我们已经对齐了受刺激和控制细胞，我们可以开始进行比较分析并查看刺激引起的差异。广泛观察这些变化的一种方法是绘制受刺激细胞和对照细胞的平均表达，并在散点图上寻找视觉异常值的基因。在这里，我们取受刺激和对照幼稚 T 细胞和 CD14 单核细胞群的平均表达，并生成散点图，突出显示对干扰素刺激有显着反应的基因。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggplot2</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">cowplot</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">theme_set</span>(<span class="cm-variable">theme_cowplot</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">t.cells</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">subset</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">idents</span> <span class="cm-operator">=</span> <span class="cm-string">"CD4 Naive T"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Idents</span>(<span class="cm-variable">t.cells</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"stim"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">avg.t.cells</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.data.frame</span>(<span class="cm-variable">log1p</span>(<span class="cm-variable">AverageExpression</span>(<span class="cm-variable">t.cells</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">RNA</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">avg.t.cells</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">gene</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">avg.t.cells</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cd14.mono</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">subset</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">idents</span> <span class="cm-operator">=</span> <span class="cm-string">"CD14 Mono"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Idents</span>(<span class="cm-variable">cd14.mono</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"stim"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">avg.cd14.mono</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.data.frame</span>(<span class="cm-variable">log1p</span>(<span class="cm-variable">AverageExpression</span>(<span class="cm-variable">cd14.mono</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">RNA</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">avg.cd14.mono</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">gene</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">avg.cd14.mono</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">genes.to.label</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"ISG15"</span>, <span class="cm-string">"LY6E"</span>, <span class="cm-string">"IFI6"</span>, <span class="cm-string">"ISG20"</span>, <span class="cm-string">"MX1"</span>, <span class="cm-string">"IFIT2"</span>, <span class="cm-string">"IFIT1"</span>, <span class="cm-string">"CXCL10"</span>, <span class="cm-string">"CCL8"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ggplot</span>(<span class="cm-variable">avg.t.cells</span>, <span class="cm-variable">aes</span>(<span class="cm-variable">CTRL</span>, <span class="cm-variable">STIM</span>)) <span class="cm-operator">+</span> <span class="cm-variable">geom_point</span>() <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"CD4 Naive T Cells"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">LabelPoints</span>(<span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">p1</span>, <span class="cm-variable">points</span> <span class="cm-operator">=</span> <span class="cm-variable">genes.to.label</span>, <span class="cm-variable">repel</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ggplot</span>(<span class="cm-variable">avg.cd14.mono</span>, <span class="cm-variable">aes</span>(<span class="cm-variable">CTRL</span>, <span class="cm-variable">STIM</span>)) <span class="cm-operator">+</span> <span class="cm-variable">geom_point</span>() <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"CD14 Monocytes"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">LabelPoints</span>(<span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">p2</span>, <span class="cm-variable">points</span> <span class="cm-operator">=</span> <span class="cm-variable">genes.to.label</span>, <span class="cm-variable">repel</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator">+</span> <span class="cm-variable">p2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 506px;"></div><div class="CodeMirror-gutters" style="display: none; height: 506px;"></div></div></div></pre><p><img src="images/scatterplots-1.png" referrerpolicy="no-referrer"></p><p><span>在不同条件下识别出常见的细胞类型，所以我们可以</span><mark><span>询问相同类型细胞在不同条件下哪些基因会发生变化</span></mark><span>。首先，我们在 meta.data 槽中创建一个列来保存细胞类型和刺激信息，并将当前标识切换到该列。然后我们</span><code>FindMarkers()</code><span>用来寻找刺激和对照 B 细胞之间不同的基因。请注意，此处显示的许多顶级基因与我们之前绘制的核心干扰素反应基因相同。此外，我们看到的 CXCL10 等特定于单核细胞和 B 细胞干扰素反应的基因在此列表中也显示出非常重要的意义。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">celltype.stim</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">paste</span>(<span class="cm-variable">Idents</span>(<span class="cm-variable">immune.combined</span>), <span class="cm-variable">immune.combined</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">stim</span>, <span class="cm-variable">sep</span> <span class="cm-operator">=</span> <span class="cm-string">"_"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">celltype</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Idents</span>(<span class="cm-variable">immune.combined</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Idents</span>(<span class="cm-variable">immune.combined</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"celltype.stim"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b.interferon.response</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-string">"B_STIM"</span>, <span class="cm-variable">ident.2</span> <span class="cm-operator">=</span> <span class="cm-string">"B_CTRL"</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">b.interferon.response</span>, <span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-number">15</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><span>可视化在基因表达的这些变化的另一种有用的方法是使用</span><code>split.by</code><span>选项给</span><code>FeaturePlot()</code><span>或</span><code>VlnPlot()</code><span>功能。这将显示给定基因列表的特征图，按分组变量（此处为刺激条件）拆分。CD3D 和 GNLY 等基因是典型的细胞类型标记（用于 T 细胞和 NK/CD8 T 细胞），它们几乎不受干扰素刺激的影响，并且在对照组和受刺激组中显示出相似的基因表达模式。另一方面，IFI6 和 ISG15 是核心干扰素反应基因，并在所有细胞类型中相应上调。最后，CD14 和 CXCL10 是显示细胞类型特异性干扰素反应的基因。刺激 CD14 单核细胞后 CD14 表达降低，这可能导致监督分析框架中的错误分类，强调了综合分析的价值。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"CD3D"</span>, <span class="cm-string">"GNLY"</span>, <span class="cm-string">"IFI6"</span>), <span class="cm-variable">split.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>, <span class="cm-variable">max.cutoff</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">cols</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"grey"</span>, <span class="cm-string">"red"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plots</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">VlnPlot</span>(<span class="cm-variable">immune.combined</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"LYZ"</span>, <span class="cm-string">"ISG15"</span>, <span class="cm-string">"CXCL10"</span>), <span class="cm-variable">split.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-string">"celltype"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable">combine</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wrap_plots</span>(<span class="cm-variable">plots</span> <span class="cm-operator">=</span> <span class="cm-variable">plots</span>, <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><img src="images/splitvln-1.png" referrerpolicy="no-referrer"></p><h4 id='使用-sctransform-规范化的数据集执行整合'><span>使用 SCTransform 规范化的数据集执行整合</span></h4><p><span>在</span><a href='https://genomebiology.biomedcentral.com/articles/10.1186/s13059-019-1874-1'><span>Hafemeister 和 Satija，2019 年</span></a><span>，介绍了一种基于正则化负二项式回归的改进的 scRNA-seq 标准化方法。该方法被命名为“sctransform”，并避免了标准规范化工作流程的一些缺陷，包括添加伪计数和对数转换。</span></p><p><span>有一些关键区别：</span></p><ul><li><span>通过 单独规范化数据集</span><code>SCTransform()</code><span>，而不是</span><code>NormalizeData()</code><span>在集成之前</span></li><li><span>正如我们在</span><a href='https://satijalab.org/seurat/articles/sctransform_vignette.html'><span>SCTransform 小插图中</span></a><span>进一步讨论的</span><a href='https://satijalab.org/seurat/articles/sctransform_vignette.html'><span>那样</span></a><span>，我们通常使用 3,000 个或更多特征来分析 sctransform 的下游。</span></li><li><code>PrepSCTIntegration()</code><span>在识别锚点之前运行函数</span></li><li><span>运行</span><code>FindIntegrationAnchors()</code><span>时</span><code>IntegrateData()</code><span>，设置</span><code>normalization.method</code><span>参数为值</span><code>SCT</code><span>。</span></li><li><span>运行基于 sctransform 的工作流（包括集成）时，请勿运行该</span><code>ScaleData()</code><span>函数</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">LoadData</span>(<span class="cm-string">"ifnb"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ifnb.list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SplitObject</span>(<span class="cm-variable">ifnb</span>, <span class="cm-variable">split.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ifnb.list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">X</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>, <span class="cm-variable">FUN</span> <span class="cm-operator">=</span> <span class="cm-variable">SCTransform</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">features</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SelectIntegrationFeatures</span>(<span class="cm-variable">object.list</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>, <span class="cm-variable">nfeatures</span> <span class="cm-operator">=</span> <span class="cm-number">3000</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ifnb.list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">PrepSCTIntegration</span>(<span class="cm-variable">object.list</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>, <span class="cm-variable">anchor.features</span> <span class="cm-operator">=</span> <span class="cm-variable">features</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">### 运行FindIntegrationAnchors()时IntegrateData()，设置normalization.method参数为值SCT。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.anchors</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindIntegrationAnchors</span>(<span class="cm-variable">object.list</span> <span class="cm-operator">=</span> <span class="cm-variable">ifnb.list</span>, <span class="cm-variable">normalization.method</span> <span class="cm-operator">=</span> <span class="cm-string">"SCT"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">anchor.features</span> <span class="cm-operator">=</span> <span class="cm-variable">features</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined.sct</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">IntegrateData</span>(<span class="cm-variable">anchorset</span> <span class="cm-operator">=</span> <span class="cm-variable">immune.anchors</span>, <span class="cm-variable">normalization.method</span> <span class="cm-operator">=</span> <span class="cm-string">"SCT"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined.sct</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">immune.combined.sct</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">immune.combined.sct</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunUMAP</span>(<span class="cm-variable">immune.combined.sct</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"pca"</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">30</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">immune.combined.sct</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-string">"stim"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">immune.combined.sct</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-string">"seurat_annotations"</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">repel</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator">+</span> <span class="cm-variable">p2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><p><img src="images/immunesca.cca.sct.split.dims-1.png" referrerpolicy="no-referrer"></p><p>&nbsp;</p><h2 id='将-seurat-与多模式数据一起使用'><span>将 Seurat 与多模式数据一起使用</span></h2><p><span>从同一个细胞同时测量多种数据类型的能力，称为多模态分析。首先，加载两个计数矩阵：一个用于 RNA 测量，一个用于抗体衍生标签 (ADT)。</span></p><ol start='' ><li><span>加载数据</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggplot2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">patchwork</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Load in the RNA UMI matrix</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Note that this dataset also contains ~5% of mouse cells, which we can use as negative</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># controls for the protein measurements. For this reason, the gene expression matrix has</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># HUMAN_ or MOUSE_ appended to the beginning of each gene.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc.rna</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.sparse</span>(<span class="cm-variable">read.csv</span>(<span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"../data/GSE100866_CBMC_8K_13AB_10X-RNA_umi.csv.gz"</span>, <span class="cm-variable">sep</span> <span class="cm-operator">=</span> <span class="cm-string">","</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>, <span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># To make life a bit easier going forward, we're going to discard all but the top 100 most</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># highly expressed mouse genes, and remove the 'HUMAN_' from the CITE-seq prefix</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc.rna</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CollapseSpeciesExpressionMatrix</span>(<span class="cm-variable">cbmc.rna</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Load in the ADT UMI matrix</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc.adt</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.sparse</span>(<span class="cm-variable">read.csv</span>(<span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"../data/GSE100866_CBMC_8K_13AB_10X-ADT_umi.csv.gz"</span>, <span class="cm-variable">sep</span> <span class="cm-operator">=</span> <span class="cm-string">","</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>, <span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Note that since measurements were made in the same cells, the two matrices have identical column names</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">all.equal</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">cbmc.rna</span>), <span class="cm-variable">colnames</span>(<span class="cm-variable">cbmc.adt</span>))</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 616px;"></div><div class="CodeMirror-gutters" style="display: none; height: 616px;"></div></div></div></pre><ol start='' ><li><span>设置 Seurat 对象，添加 RNA 和蛋白质数据</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># creates a Seurat object based on the scRNA-seq data</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateSeuratObject</span>(<span class="cm-variable">counts</span> <span class="cm-operator">=</span> <span class="cm-variable">cbmc.rna</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># We can see that by default, the cbmc object contains an assay storing RNA measurement</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Assays</span>(<span class="cm-variable">cbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># create a new assay to store ADT information</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">adt_assay</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateAssayObject</span>(<span class="cm-variable">counts</span> <span class="cm-operator">=</span> <span class="cm-variable">cbmc.adt</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># add this assay to the previously created Seurat object</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span>[[<span class="cm-string">"ADT"</span>]] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">adt_assay</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Validate that the object now contains multiple assays</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Assays</span>(<span class="cm-variable">cbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Switch the default to ADT(switch)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"ADT"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 418px;"></div><div class="CodeMirror-gutters" style="display: none; height: 418px;"></div></div></div></pre><ol start='' ><li><span>基于它们的 scRNA-seq 的数据对细胞进行聚类</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Note that all operations below are performed on the RNA assay Set and verify that the</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># default assay is RNA</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"RNA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># perform visualization and clustering steps</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">cbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindVariableFeatures</span>(<span class="cm-variable">cbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">ScaleData</span>(<span class="cm-variable">cbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunPCA</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindNeighbors</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">30</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindClusters</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">resolution</span> <span class="cm-operator">=</span> <span class="cm-number">0.8</span>, <span class="cm-variable">verbose</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunUMAP</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">30</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 330px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><p><img src="images/cluster1-1.png" referrerpolicy="no-referrer"></p><ol start='' ><li><span>并排显示多种模式的结果</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Normalize ADT data,</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"ADT"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">normalization.method</span> <span class="cm-operator">=</span> <span class="cm-string">"CLR"</span>, <span class="cm-variable">margin</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"RNA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Note that the following command is an alternative but returns the same result</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">normalization.method</span> <span class="cm-operator">=</span> <span class="cm-string">"CLR"</span>, <span class="cm-variable">margin</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>, <span class="cm-variable">assay</span> <span class="cm-operator">=</span> <span class="cm-string">"ADT"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Now, we will visualize CD14 levels for RNA and protein By setting the default assay, we can</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># visualize one or the other</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"ADT"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">cbmc</span>, <span class="cm-string">"CD19"</span>, <span class="cm-variable">cols</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"lightgrey"</span>, <span class="cm-string">"darkgreen"</span>)) <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"CD19 protein"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DefaultAssay</span>(<span class="cm-variable">cbmc</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"RNA"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">cbmc</span>, <span class="cm-string">"CD19"</span>) <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"CD19 RNA"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># place plots side-by-side</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator">|</span> <span class="cm-variable">p2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 418px;"></div><div class="CodeMirror-gutters" style="display: none; height: 418px;"></div></div></div></pre><p><img src="images/vis-1.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Alternately, we can use specific assay keys to specify a specific modality Identify the key</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># for the RNA and protein assays</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Key</span>(<span class="cm-variable">cbmc</span>[[<span class="cm-string">"RNA"</span>]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Key</span>(<span class="cm-variable">cbmc</span>[[<span class="cm-string">"ADT"</span>]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Now, we can include the key in the feature name, which overrides the default assay</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">cbmc</span>, <span class="cm-string">"adt_CD19"</span>, <span class="cm-variable">cols</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"lightgrey"</span>, <span class="cm-string">"darkgreen"</span>)) <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"CD19 protein"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">cbmc</span>, <span class="cm-string">"rna_CD19"</span>) <span class="cm-operator">+</span> <span class="cm-variable">ggtitle</span>(<span class="cm-string">"CD19 RNA"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator">|</span> <span class="cm-variable">p2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p><img src="images/vis-2.png" referrerpolicy="no-referrer"></p><ol start='' ><li><span>识别 scRNA-seq 簇的细胞表面标记</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># as we know that CD19 is a B cell marker, we can identify cluster 6 as expressing CD19 on the</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># surface</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">VlnPlot</span>(<span class="cm-variable">cbmc</span>, <span class="cm-string">"adt_CD19"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># we can also identify alternative protein and RNA markers for this cluster through</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># differential expression</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">adt_markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">assay</span> <span class="cm-operator">=</span> <span class="cm-string">"ADT"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rna_markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">assay</span> <span class="cm-operator">=</span> <span class="cm-string">"RNA"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">adt_markers</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><img src="images/markers-1.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># we can also identify alternative protein and RNA markers for this cluster through</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># differential expression</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">adt_markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">assay</span> <span class="cm-operator">=</span> <span class="cm-string">"ADT"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rna_markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">assay</span> <span class="cm-operator">=</span> <span class="cm-string">"RNA"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">adt_markers</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><ol start='' ><li><span>多模式数据的其他可视化</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Draw ADT scatter plots (like biaxial plots for FACS). Note that you can even 'gate' cells if</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># desired by using HoverLocator and FeatureLocator</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD19"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD3"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><img src="images/viz.cite.two-1.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># view relationship between protein and RNA</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD3"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"rna_CD3E"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><img src="images/viz.cite.two-2.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD4"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD8"</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><img src="images/viz.cite.two-3.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Let's look at the raw (non-normalized) ADT counts. You can see the values are quite high,</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># particularly in comparison to RNA values. This is due to the significantly higher protein</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># copy number in cells, which significantly reduces 'drop-out' in ADT data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">cbmc</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD4"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD8"</span>, <span class="cm-variable">slot</span> <span class="cm-operator">=</span> <span class="cm-string">"counts"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><p><img src="images/viz.cite.two-4.png" referrerpolicy="no-referrer"></p><ol start='' ><li><span>从 10X 多模态实验中加载数据</span></li></ol><p><span>Seurat 还能够分析来自使用 CellRanger v3 处理的多模式 10X 实验的数据；例如，我们使用 7,900 个外周血单个核细胞 (PBMC) 的数据集重新创建了上面的图。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc10k.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Read10X</span>(<span class="cm-variable">data.dir</span> <span class="cm-operator">=</span> <span class="cm-string">"../data/pbmc10k/filtered_feature_bc_matrix/"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rownames</span>(<span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc10k.data</span>[[<span class="cm-string">"Antibody Capture"</span>]]) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">gsub</span>(<span class="cm-variable">pattern</span> <span class="cm-operator">=</span> <span class="cm-string">"_[control_]*TotalSeqB"</span>, <span class="cm-variable">replacement</span> <span class="cm-operator">=</span> <span class="cm-string">""</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc10k.data</span>[[<span class="cm-string">"Antibody Capture"</span>]]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc10k</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateSeuratObject</span>(<span class="cm-variable">counts</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc10k.data</span>[[<span class="cm-string">"Gene Expression"</span>]], <span class="cm-variable">min.cells</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>, <span class="cm-variable">min.features</span> <span class="cm-operator">=</span> <span class="cm-number">200</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc10k</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">pbmc10k</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc10k</span>[[<span class="cm-string">"ADT"</span>]] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateAssayObject</span>(<span class="cm-variable">pbmc10k.data</span>[[<span class="cm-string">"Antibody Capture"</span>]][, <span class="cm-variable">colnames</span>(<span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc10k</span>)])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc10k</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">NormalizeData</span>(<span class="cm-variable">pbmc10k</span>, <span class="cm-variable">assay</span> <span class="cm-operator">=</span> <span class="cm-string">"ADT"</span>, <span class="cm-variable">normalization.method</span> <span class="cm-operator">=</span> <span class="cm-string">"CLR"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">pbmc10k</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD19"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD3"</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">pbmc10k</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD4"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD8a"</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot3</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FeatureScatter</span>(<span class="cm-variable">pbmc10k</span>, <span class="cm-variable">feature1</span> <span class="cm-operator">=</span> <span class="cm-string">"adt_CD3"</span>, <span class="cm-variable">feature2</span> <span class="cm-operator">=</span> <span class="cm-string">"CD3E"</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(<span class="cm-variable">plot1</span> <span class="cm-operator">+</span> <span class="cm-variable">plot2</span> <span class="cm-operator">+</span> <span class="cm-variable">plot3</span>) <span class="cm-operator">&amp;</span> <span class="cm-variable">NoLegend</span>()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 418px;"></div><div class="CodeMirror-gutters" style="display: none; height: 418px;"></div></div></div></pre><p><img src="images/pbmc10x-1.png" referrerpolicy="no-referrer"></p><h2 id='下游分析'><span>下游分析</span></h2><h3 id='细胞水平'><span>细胞水平</span></h3><h4 id='簇'><span>簇</span></h4><h5 id='聚类分析'><span>聚类分析</span></h5><ol start='' ><li><span>Seurat包</span></li></ol><p><span>应用： scRNA-seq 数据、CyTOF 数据</span></p><ul><li><span>这些方法将细胞嵌入到一个图结构中——例如一个 K-最近邻 (KNN) 图，在具有相似基因表达模式的单元之间绘制边，然后尝试将该图划分为高度互连的“准集团”或“群体”。</span></li><li><span>首先基于 PCA 空间中的欧几里德距离构建一个 KNN 图，并基于其局部邻域中的共享重叠（Jaccard 相似性）细化任意两个单元之间的边权重。此步骤使用该</span><code>FindNeighbors()</code><span>函数执行，并将先前定义的数据集维度（前 10 个 PC）作为输入。</span></li><li><span>为了对细胞进行聚类，我们接下来应用模块化优化技术，例如 Louvain 算法（默认）或 SLM ，以迭代方式将细胞分组在一起，目标是优化标准模块化函数. 该FindClusters()函数实现了这个过程，并包含一个分辨率参数，用于设置下游聚类的“分辨率（resolution）”，</span><mark><span>分辨率增加会得到更多的簇。我们发现，将这个参数设置在 0.4-1.2 之间通常会为大约 3K 细胞的单细胞数据集返回较好的聚类结果。</span></mark><span>对于较大的数据集，最佳分辨率通常会增加。可以使用该</span><code>Idents()</code><span>函数找到簇。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindNeighbors</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">10</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindClusters</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">resolution</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><img src="images/2021-10-24-22-19-43.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Look at cluster IDs of the first 5 cells</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">Idents</span>(<span class="cm-variable">pbmc</span>), <span class="cm-number">5</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><img src="images/2021-10-24-22-20-14.png" referrerpolicy="no-referrer"></p><ol start='2' ><li><span>通过伪时间表达模式聚类基因</span></li></ol><p><span>在研究时间序列基因表达研究时出现的一个常见问题是：“哪些基因遵循相似的动力学趋势”？Monocle 可以通过对具有相似趋势的基因进行分组来帮助您回答这个问题，因此您可以分析这些组以查看它们的共同点。Monocle 提供了一种可视化所有伪时间依赖性基因的便捷方法。该函数</span><code>plot_pseudotime_heatmap</code><span>接受一个</span><code>CellDataSet</code><span>对象（通常只包含重要基因的一个子集）并生成平滑的表达曲线，就像</span><code>plot_genes_in_pseudotime</code><span>。然后，它对这些基因进行聚类并使用pheatmap包绘制它们，可以</span><strong><span>可视化跨伪时间共变的基因模块</span></strong><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">diff_test_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">differentialGeneTest</span>(<span class="cm-variable">HSMM_myo</span>[<span class="cm-variable">marker_genes</span>,],</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">fullModelFormulaStr</span> <span class="cm-operator">=</span> <span class="cm-string">"~sm.ns(Pseudotime)"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sig_gene_names</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">diff_test_res</span>, <span class="cm-variable">qval</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0.1</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_pseudotime_heatmap</span>(<span class="cm-variable">HSMM_myo</span>[<span class="cm-variable">sig_gene_names</span>,],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_clusters</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cores</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">show_rownames</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p><img src="images/2021-10-25-14-30-50.png" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h5 id='对簇进行细胞类型注释'><span>对簇进行细胞类型注释</span></h5><ol start='' ><li><span>Seurat包</span>
<span>将无偏聚类与已知细胞类型匹配，并进行注释，</span><mark><span>属于先验知识进行注释，为无监督学习。</span></mark></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">new.cluster.ids</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">c</span>(<span class="cm-string">"Naive CD4 T"</span>, <span class="cm-string">"CD14+ Mono"</span>, <span class="cm-string">"Memory CD4 T"</span>, <span class="cm-string">"B"</span>, <span class="cm-string">"CD8 T"</span>, <span class="cm-string">"FCGR3A+ Mono"</span>,<span class="cm-string">"NK"</span>, <span class="cm-string">"DC"</span>, <span class="cm-string">"Platelet"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">names</span>(<span class="cm-variable">new.cluster.ids</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">levels</span>(<span class="cm-variable">pbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RenameIdents</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">new.cluster.ids</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>)<span class="cm-operator">+</span><span class="cm-variable">NoLegend</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">saveRDS</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"../output/pbmc3k_final.rds"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><p><img src="images/2021-10-25-14-38-05.png" referrerpolicy="no-referrer"></p><ol start='2' ><li><span>SingleR包</span></li></ol><p><span>SingleR利用纯细胞类型的参考转录组数据集来独立推断每个单细胞的细胞可能类型。SingleR的注释与Seurat(一个为scRNA-seq设计的处理和分析包)相结合，为研究scRNA-seq数据提供了一个强大的工具。SingleR提供了内置的包装函数，可以用一个函数运行完整的流程。SingleR与Seurat交互较好，但是也可以使用任何其他scRNA-seq包，使用该包所有的数据集,网址如下。</span>
<a href='https://bioconductor.org/packages/release/data/experiment/vignettes/scRNAseq/inst/doc/scRNAseq.html#references' target='_blank' class='url'>https://bioconductor.org/packages/release/data/experiment/vignettes/scRNAseq/inst/doc/scRNAseq.html#references</a></p><p><span>原理：首先，计算参考数据集中每个样本的单细胞表达的spearman系数。相关分析仅对参考数据集中的可变基因（variable genes）进行。接着，根据参考数据集的命名注释聚合每个细胞类型的多个相关系数，从而为每个细胞类型提供一个值。接着SingleR将重新运行相关分析，但只针对上一步中的相关性较高的细胞类型。该分析仅对这些细胞类型之间的可变基因进行。移除最低值的细胞类型(或比最高值低0.05的边缘)，然后重复此步骤，直到只保留两种细胞类型。最后一次运行后，与顶部值对应的细胞类型被分配给单个细胞。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 根据需求选择上述网站的数据集作为SingleR的参考数据集</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">imm_ref</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DatabaseImmuneCellExpressionData</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 进行细胞类型注释（一般选择第二种，可以直接注释Seurat聚类结果）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pred_single</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SingleR</span>(<span class="cm-variable">test</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT</span>@<span class="cm-variable">data</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ref</span> <span class="cm-operator">=</span> <span class="cm-variable">imm_ref</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">labels</span> <span class="cm-operator">=</span> <span class="cm-variable">imm_ref</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">genes</span> <span class="cm-operator">=</span> <span class="cm-string">"de"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">de.method</span> <span class="cm-operator">=</span> <span class="cm-string">"wilcox"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pred_cluster</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SingleR</span>(<span class="cm-variable">test</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT</span>@<span class="cm-variable">data</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ref</span> <span class="cm-operator">=</span> <span class="cm-variable">imm_ref</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">labels</span> <span class="cm-operator">=</span> <span class="cm-variable">imm_ref</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">clusters</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT_snn_res.0.6</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">genes</span> <span class="cm-operator">=</span> <span class="cm-string">"de"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">de.method</span> <span class="cm-operator">=</span> <span class="cm-string">"wilcox"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">save</span>(<span class="cm-variable">pred_single</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"pred_single.rda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">save</span>(<span class="cm-variable">pred_cluster</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"pred_cluster.rda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># plot</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">x</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">seurat_celltype</span> <span class="cm-operator">=</span> <span class="cm-variable">Idents</span>(<span class="cm-variable">pbmc</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sr_single_first_ct</span> <span class="cm-operator">=</span> <span class="cm-variable">pred_single</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">first.labels</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sr_single_ct</span> <span class="cm-operator">=</span> <span class="cm-variable">pred_single</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sr_single_pruned_ct</span> <span class="cm-operator">=</span> <span class="cm-variable">pred_single</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">pruned.labels</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sr_cluster_first_ct</span> <span class="cm-operator">=</span> <span class="cm-variable">RenameCluster</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT_snn_res.0.6</span>, <span class="cm-variable">pred_cluster</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">first.labels</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sr_cluster_ct</span> <span class="cm-operator">=</span> <span class="cm-variable">RenameCluster</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT_snn_res.0.6</span>, <span class="cm-variable">pred_cluster</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sr_cluster_pruned_ct</span> <span class="cm-operator">=</span> <span class="cm-variable">RenameCluster</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT_snn_res.0.6</span>, <span class="cm-variable">pred_cluster</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">pruned.labels</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cbind</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>, <span class="cm-variable">x</span>, <span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plist</span> <span class="cm-operator">=</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">x</span>), <span class="cm-keyword">function</span>(<span class="cm-variable">col</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span><span class="cm-operator">=</span><span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1.5</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">labs</span>(<span class="cm-variable">title</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"singer_compare_all.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-variable">plist</span>, <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">15</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plist</span> <span class="cm-operator">=</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">x</span>)[<span class="cm-variable">c</span>(<span class="cm-number">1</span>,<span class="cm-number">6</span>,<span class="cm-number">3</span>)], <span class="cm-keyword">function</span>(<span class="cm-variable">col</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span><span class="cm-operator">=</span><span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1.5</span>) <span class="cm-operator">+</span> <span class="cm-variable">labs</span>(<span class="cm-variable">title</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>) <span class="cm-operator">+</span> <span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> <span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"singer_compare_ct.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-variable">plist</span>, <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">https</span><span class="cm-operator">://</span><span class="cm-variable">nbisweden.github.io</span><span class="cm-operator">/</span><span class="cm-variable">excelerate</span><span class="cm-operator">-</span><span class="cm-variable">scRNAseq</span><span class="cm-operator">/</span><span class="cm-variable">session</span><span class="cm-operator">-</span><span class="cm-variable">celltypeid</span><span class="cm-operator">/</span><span class="cm-variable">celltypeid.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1188px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1188px;"></div></div></div></pre><hr /><p><span>Update：SingleR包进行改版和更新 建议使用以下的代码。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="R" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Cell_typing</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># SingleR细胞类型注释</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">readRDS</span>(<span class="cm-string">"Markers/Markers_0.5.rds"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># SCTransform()函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SCTransform</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">vars.to.regress</span> <span class="cm-operator">=</span> <span class="cm-string">"percent.mt"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Load the SingleRdata &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data_for_SingleR</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">GetAssayData</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">slot</span><span class="cm-operator">=</span><span class="cm-string">"data"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">clusters</span><span class="cm-operator">=</span><span class="cm-variable">Seurat.data</span>@<span class="cm-variable">meta.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">seurat_clusters</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 根据需求选择上述网站的数据集作为SingleR的参考数据集</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">SingleR</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">scRNAseq</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">celldex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#### Human being ####</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####################</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## Using multiple references</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">celldex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">hpca</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">HumanPrimaryCellAtlasData</span>(<span class="cm-variable">ensembl</span><span class="cm-operator">=</span><span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bpe</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">BlueprintEncodeData</span>(<span class="cm-variable">ensembl</span><span class="cm-operator">=</span><span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## annotation</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pred.human</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SingleR</span>(<span class="cm-variable">test</span> <span class="cm-operator">=</span> <span class="cm-variable">Seurat.data_for_SingleR</span>, <span class="cm-variable">assay.type.test</span><span class="cm-operator">=</span><span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ref</span> <span class="cm-operator">=</span> <span class="cm-builtin">list</span>(<span class="cm-variable">BPE</span><span class="cm-operator">=</span><span class="cm-variable">bpe</span>, <span class="cm-variable">HPCA</span><span class="cm-operator">=</span><span class="cm-variable">hpca</span>), </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">labels</span> <span class="cm-operator">=</span> <span class="cm-builtin">list</span>(<span class="cm-variable">bpe</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>, <span class="cm-variable">hpca</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## Check the final label from the combined assignment.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">table</span>(<span class="cm-variable">pred.human</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">head</span>(<span class="cm-variable">pred.human</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">BPE</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">head</span>(<span class="cm-variable">pred.human</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">HPCA</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## visualization</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">hpca_type</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pred.human</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">HPCA</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">bpe_typ</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pred.human</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">BPE</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## visualization</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">ggsci</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-string">'hpca_type'</span>,<span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>)<span class="cm-operator">+</span><span class="cm-variable">scale_color_ucscgb</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-string">'bpe_type'</span>,<span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>)<span class="cm-operator">+</span><span class="cm-variable">scale_color_ucscgb</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">cowplot</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p</span><span class="cm-operator cm-arrow">&lt;-</span><span class="cm-variable">plot_grid</span>(<span class="cm-variable">p1</span>, <span class="cm-variable">p2</span>, <span class="cm-variable">nrow</span><span class="cm-operator">=</span><span class="cm-number">1</span>, <span class="cm-variable">ncol</span><span class="cm-operator">=</span><span class="cm-number">2</span>, <span class="cm-variable">labels</span><span class="cm-operator">=</span><span class="cm-variable">panel.labels</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ggsave</span>(<span class="cm-string">"singler.pdf"</span>, <span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">p</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">15</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">####### Mouse #######</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####################</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">celldex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">#immgen &lt;- ImmGenData()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">immgen</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">celldex</span><span class="cm-operator">::</span><span class="cm-variable">ImmGenData</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">mouseRNA</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">celldex</span><span class="cm-operator">::</span><span class="cm-variable">MouseRNAseqData</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">monacoImm</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">celldex</span><span class="cm-operator">::</span><span class="cm-variable">MonacoImmuneData</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## annotation</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">pred.mouse</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SingleR</span>(<span class="cm-variable">test</span> <span class="cm-operator">=</span> <span class="cm-variable">Seurat.data_for_SingleR</span>, <span class="cm-variable">assay.type.test</span><span class="cm-operator">=</span><span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ref</span> <span class="cm-operator">=</span> <span class="cm-builtin">list</span>(<span class="cm-variable">Immgen</span><span class="cm-operator">=</span><span class="cm-variable">immgen</span>, <span class="cm-variable">MouseRNA</span><span class="cm-operator">=</span><span class="cm-variable">mouseRNA</span>,<span class="cm-variable">MonacoImmune</span><span class="cm-operator">=</span><span class="cm-variable">monacoImm</span>), </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">labels</span> <span class="cm-operator">=</span> <span class="cm-builtin">list</span>(<span class="cm-variable">immgen</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>, <span class="cm-variable">mouseRNA</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>,<span class="cm-variable">monacoImm</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label.main</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## Check the final label from the combined assignment.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">table</span>(<span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## Check the 'winning' reference for each cell.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">table</span>(<span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">reference</span>) &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">head</span>(<span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">Immgen</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>) &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">head</span>(<span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">MouseRNA</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">head</span>(<span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">MonacoImmune</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## visualization</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">immgen</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">Immgen</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">MouseRNA</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">MouseRNA</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Seurat.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">MonacoImmun</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pred.mouse</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">orig.results</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">MonacoImmune</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">labels</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">ggsci</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-string">'immgen'</span>,<span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>)<span class="cm-operator">+</span><span class="cm-variable">scale_color_ucscgb</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-string">'MouseRNA'</span>,<span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>)<span class="cm-operator">+</span><span class="cm-variable">scale_color_ucscgb</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p3</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">DimPlot</span>(<span class="cm-variable">Seurat.data</span>, <span class="cm-variable">group.by</span><span class="cm-operator">=</span><span class="cm-string">'MonacoImmun'</span>,<span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>)<span class="cm-operator">+</span><span class="cm-variable">scale_color_ucscgb</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">library</span>(<span class="cm-variable">cowplot</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p</span><span class="cm-operator cm-arrow">&lt;-</span><span class="cm-variable">plot_grid</span>(<span class="cm-variable">p1</span>, <span class="cm-variable">p2</span>,<span class="cm-variable">p3</span>,<span class="cm-variable">nrow</span><span class="cm-operator">=</span><span class="cm-number">1</span>, <span class="cm-variable">ncol</span><span class="cm-operator">=</span><span class="cm-number">3</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ggsave</span>(<span class="cm-string">"singler.pdf"</span>, <span class="cm-variable">plot</span> <span class="cm-operator">=</span> <span class="cm-variable">p</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">15</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>) &nbsp; </span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1716px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1716px;"></div></div></div></pre><ol start='3' ><li><span>Garnett包</span>
<span>（基于监督学习的从单细胞表达数据中实现自动细胞类型分类的软件包）</span></li></ol><p><font color=#FF0000><span>！！！</span></p><p><span>该包不再支持后面提到的monocle2包，目前只支持monocle3。</span></font></p><p><span>原理：获取单细胞数据和细胞类型定义(marker)文件，并训练一个基于回归的分类器。一旦被训练成一个针对某一组织/样本类型的一个分类器，它就可以应用于从相似组织中对未来的数据集进行分类，其中分类器可以是下载现有的分类器或者训练自己的分类器。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggplot2</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggsci</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">dplyr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">tibble</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">garnett</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">monocle</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. create monocle object from seurat</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load</span>(<span class="cm-string">"~/project/sc_standard_procedure/1_framework/Seurat/3.2.3_with_SCTransform/regress_nothing/pc10/pbmc.rda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mat</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT</span>@<span class="cm-variable">counts</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fdata</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">mat</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">gene_short_name</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">mat</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pdata</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">pbmc</span>@<span class="cm-variable">reductions</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">tsne</span>@<span class="cm-variable">cell.embeddings</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rownames</span>(<span class="cm-variable">mat</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">fdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">colnames</span>(<span class="cm-variable">mat</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">pdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">fdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc3k_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">as</span>(<span class="cm-variable">mat</span>, <span class="cm-string">"dgCMatrix"</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc3k_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">estimateSizeFactors</span>(<span class="cm-variable">pbmc3k_cds</span>) <span class="cm-comment"># 归一化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. choose classifier and  classify</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">classifier</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">readRDS</span>(<span class="cm-string">"~/project/sc_standard_procedure/2_annotation/garnett/pre_trained_classifier/hsPBMC_20191017.RDS"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">org.Hs.eg.db</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc3k_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">classify_cells</span>(<span class="cm-variable">pbmc3k_cds</span>, <span class="cm-variable">classifier</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">db</span> <span class="cm-operator">=</span> <span class="cm-variable">org.Hs.eg.db</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cluster_extend</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cds_gene_id_type</span> <span class="cm-operator">=</span> <span class="cm-string">"SYMBOL"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">table</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">pbmc3k_cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell_type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">table</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">pbmc3k_cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">cluster_ext_type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. plot</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">x</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">seurat_celltype</span> <span class="cm-operator">=</span> <span class="cm-variable">Idents</span>(<span class="cm-variable">pbmc</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">garnett_cell_type</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">pbmc3k_cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell_type</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">garnett_cluster_ext_type</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">pbmc3k_cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">cluster_ext_type</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cbind</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>, <span class="cm-variable">x</span>, <span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plist</span> <span class="cm-operator">=</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">x</span>), <span class="cm-keyword">function</span>(<span class="cm-variable">col</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span><span class="cm-operator">=</span><span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1.5</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">labs</span>(<span class="cm-variable">title</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"garnett_compare_all_1.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-variable">plist</span>, <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">16</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"garnett_compare_all_2.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-variable">plist</span>, <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">16</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">writeLines</span>(<span class="cm-variable">capture.output</span>(<span class="cm-variable">sessionInfo</span>()), <span class="cm-string">"sessionInfo.txt"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1 create monocle object</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mat</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Matrix</span><span class="cm-operator">::</span><span class="cm-variable">readMM</span>(<span class="cm-variable">system.file</span>(<span class="cm-string">"extdata"</span>, <span class="cm-string">"exprs_sparse.mtx"</span>, <span class="cm-variable">package</span> <span class="cm-operator">=</span> <span class="cm-string">"garnett"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fdata</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.table</span>(<span class="cm-variable">system.file</span>(<span class="cm-string">"extdata"</span>, <span class="cm-string">"fdata.txt"</span>, <span class="cm-variable">package</span> <span class="cm-operator">=</span> <span class="cm-string">"garnett"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pdata</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.table</span>(<span class="cm-variable">system.file</span>(<span class="cm-string">"extdata"</span>, <span class="cm-string">"pdata.txt"</span>, <span class="cm-variable">package</span> <span class="cm-operator">=</span> <span class="cm-string">"garnett"</span>), <span class="cm-variable">sep</span><span class="cm-operator">=</span><span class="cm-string">"</span><span class="cm-string-2">\t</span><span class="cm-string">"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">row.names</span>(<span class="cm-variable">mat</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">fdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">colnames</span>(<span class="cm-variable">mat</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">pdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">fdata</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">as</span>(<span class="cm-variable">mat</span>, <span class="cm-string">"dgCMatrix"</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">estimateSizeFactors</span>(<span class="cm-variable">pbmc_cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2 check marker</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">org.Hs.eg.db</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marker_file_path</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">system.file</span>(<span class="cm-string">"extdata"</span>, <span class="cm-string">"pbmc_bad_markers.txt"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">package</span> <span class="cm-operator">=</span> <span class="cm-string">"garnett"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marker_check</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">check_markers</span>(<span class="cm-variable">pbmc_cds</span>, <span class="cm-variable">marker_file_path</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">db</span><span class="cm-operator">=</span><span class="cm-variable">org.Hs.eg.db</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cds_gene_id_type</span> <span class="cm-operator">=</span> <span class="cm-string">"SYMBOL"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">marker_file_gene_id_type</span> <span class="cm-operator">=</span> <span class="cm-string">"SYMBOL"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_markers</span>(<span class="cm-variable">marker_check</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3 train classifier</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">org.Hs.eg.db</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">set.seed</span>(<span class="cm-number">260</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marker_file_path</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">system.file</span>(<span class="cm-string">"extdata"</span>, <span class="cm-string">"pbmc_test.txt"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">package</span> <span class="cm-operator">=</span> <span class="cm-string">"garnett"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc_classifier</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">train_cell_classifier</span>(<span class="cm-variable">cds</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc_cds</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">marker_file</span> <span class="cm-operator">=</span> <span class="cm-variable">marker_file_path</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">db</span><span class="cm-operator">=</span><span class="cm-variable">org.Hs.eg.db</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cds_gene_id_type</span> <span class="cm-operator">=</span> <span class="cm-string">"SYMBOL"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">num_unknown</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">marker_file_gene_id_type</span> <span class="cm-operator">=</span> <span class="cm-string">"SYMBOL"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">feature_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">get_feature_genes</span>(<span class="cm-variable">pbmc_classifier</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">node</span> <span class="cm-operator">=</span> <span class="cm-string">"root"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">db</span> <span class="cm-operator">=</span> <span class="cm-variable">org.Hs.eg.db</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">get_classifier_references</span>(<span class="cm-variable">pbmc_classifier</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 4 classify your cells</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">org.Hs.eg.db</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">classify_cells</span>(<span class="cm-variable">pbmc_cds</span>, <span class="cm-variable">pbmc_classifier</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">db</span> <span class="cm-operator">=</span> <span class="cm-variable">org.Hs.eg.db</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cluster_extend</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cds_gene_id_type</span> <span class="cm-operator">=</span> <span class="cm-string">"SYMBOL"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">table</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">pbmc_cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell_type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">table</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">pbmc_cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">cluster_ext_type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggplot2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pdf</span>(<span class="cm-string">"result.pdf"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">qplot</span>(<span class="cm-variable">tsne_1</span>, <span class="cm-variable">tsne_2</span>, <span class="cm-variable">color</span> <span class="cm-operator">=</span> <span class="cm-variable">cell_type</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">pbmc_cds</span>)) <span class="cm-operator">+</span> <span class="cm-variable">theme_bw</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">qplot</span>(<span class="cm-variable">tsne_1</span>, <span class="cm-variable">tsne_2</span>, <span class="cm-variable">color</span> <span class="cm-operator">=</span> <span class="cm-variable">cluster_ext_type</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">pbmc_cds</span>)) <span class="cm-operator">+</span> <span class="cm-variable">theme_bw</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">qplot</span>(<span class="cm-variable">tsne_1</span>, <span class="cm-variable">tsne_2</span>, <span class="cm-variable">color</span> <span class="cm-operator">=</span> <span class="cm-variable">FACS_type</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">pbmc_cds</span>)) <span class="cm-operator">+</span> <span class="cm-variable">theme_bw</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">dev.off</span>()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 3212px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3212px;"></div></div></div></pre><ol start='4' ><li><span>scibet包</span></li></ol><p><span>原理：经过大量的统计分析和后续的实验验证，单细胞基因表达的count(比如UMI count)的分布可以用负二项分布很好的拟合,且相同细胞类型的单细胞表达谱服从同一个分布。因此将单细胞基因表达的count表示为泊松分布的伽马分布的混合分布，接着根据表达数据计算信息熵，挑出那些能表示不同簇细胞之间差异表达的基因，使用E-test以有监督和参数化的方式从训练集中选择细胞类型特异性基因，以去除嘈杂的基因以及通过压缩模型来加速下游分类，最后构建出基于监督学习的模型，从而对细胞类型进行注释。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">scibet</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">celldex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggplot2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggsci</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">dplyr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">tibble</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">viridis</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e-test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load</span>(<span class="cm-string">"~/project/sc_standard_procedure/1_framework/Seurat/3.2.3_with_SCTransform/regress_nothing/pc10/pbmc.rda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">expr</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.data.frame</span>(<span class="cm-variable">t</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT</span>@<span class="cm-variable">data</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">expr</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Idents</span>(<span class="cm-variable">pbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">etest_gene</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SelectGene</span>(<span class="cm-variable">expr</span>, <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">500</span>, <span class="cm-variable">r</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"marker_heatmap.png"</span>, <span class="cm-variable">Marker_heatmap</span>(<span class="cm-variable">expr</span>, <span class="cm-variable">etest_gene</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">30</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; training model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">num2</span> <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">num1</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> ( (<span class="cm-variable">num2</span><span class="cm-operator">/</span><span class="cm-variable">num1</span>) <span class="cm-operator">&lt;</span> <span class="cm-number">0.92</span> ) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># traning </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">tibble</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ID</span> <span class="cm-arg-is">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-variable">nrow</span>(<span class="cm-variable">expr</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">label</span> <span class="cm-arg-is">=</span> <span class="cm-variable">expr</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dplyr</span><span class="cm-operator">::</span><span class="cm-variable">sample_frac</span>(<span class="cm-number">0.7</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dplyr</span><span class="cm-operator">::</span><span class="cm-variable">pull</span>(<span class="cm-variable">ID</span>) <span class="cm-operator cm-arrow">-&gt;</span> <span class="cm-variable">ID</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">train_set</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">expr</span>[<span class="cm-variable">ID</span>,] &nbsp; &nbsp; &nbsp;<span class="cm-comment">#construct reference set</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">test_set</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">expr</span>[<span class="cm-operator">-</span><span class="cm-variable">ID</span>,] &nbsp; &nbsp; &nbsp;<span class="cm-comment">#construct query set</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">prd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">SciBet</span>(<span class="cm-variable">train_set</span>, <span class="cm-variable">test_set</span>[,<span class="cm-operator">-</span><span class="cm-variable">ncol</span>(<span class="cm-variable">test_set</span>)], <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">500</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># check accuracy</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">ori_label</span> <span class="cm-operator">=</span> <span class="cm-variable">test_set</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">prd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">num1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">length</span>(<span class="cm-variable">ori_label</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">num2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">tibble</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ori</span> <span class="cm-arg-is">=</span> <span class="cm-variable">ori_label</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">prd</span> <span class="cm-arg-is">=</span> <span class="cm-variable">label</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">dplyr</span><span class="cm-operator">::</span><span class="cm-variable">filter</span>(<span class="cm-variable">ori</span> <span class="cm-operator">==</span> <span class="cm-variable">prd</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">nrow</span>(<span class="cm-variable">.</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">print</span>(<span class="cm-variable">num2</span><span class="cm-operator">/</span><span class="cm-variable">num1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">model</span> <span class="cm-operator">=</span> <span class="cm-variable">Learn</span>(<span class="cm-variable">train_set</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">export_model</span> <span class="cm-operator">=</span> <span class="cm-variable">ExportModel</span>(<span class="cm-variable">model</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">write.csv</span>(<span class="cm-variable">t</span>(<span class="cm-variable">export_model</span>), <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"pbmc3k_export_model.csv"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># check model</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"confusion_heatmap.png"</span>, <span class="cm-variable">Confusion_heatmap</span>(<span class="cm-variable">as.character</span>(<span class="cm-variable">test_set</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">label</span>), <span class="cm-variable">prd</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">7</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; annotation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#----------------------------------------------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load</span>(<span class="cm-string">"~/project/sc_standard_procedure/1_preprocessing_clustering/Seurat/3.2.3_with_SCTransform/regress_nothing/pc10/pbmc.rda"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">expr</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.data.frame</span>(<span class="cm-variable">t</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT</span>@<span class="cm-variable">data</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ori_label</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">SCT_snn_res.0.6</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># reference</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ref_list</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">c</span>(<span class="cm-string">"./reference/major_human_cell_types.csv"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"./reference/GSE84465_scibet_core.csv"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"./reference/GSE109774_scibet_core.csv"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"./50gene_training_model/50gene_pbmc3k_export_model.csv"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"./500gene_training_model/500gene_pbmc3k_export_model.csv"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># predict</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">label</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">sapply</span>(<span class="cm-variable">ref_list</span>, <span class="cm-keyword">function</span>(<span class="cm-variable">ref</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># load traning model</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">model</span> <span class="cm-operator">=</span> <span class="cm-variable">read.csv</span>(<span class="cm-variable">ref</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">colnames</span>(<span class="cm-variable">model</span>) <span class="cm-operator">=</span> <span class="cm-variable">toupper</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">model</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">model</span> <span class="cm-operator">=</span> <span class="cm-variable">pro.core</span>(<span class="cm-variable">model</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># predict</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">prd</span> <span class="cm-operator">=</span> <span class="cm-variable">LoadModel</span>(<span class="cm-variable">model</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">prd</span>(<span class="cm-variable">expr</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">label_df</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">label</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">colnames</span>(<span class="cm-variable">label_df</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">stringr</span><span class="cm-operator">::</span><span class="cm-variable">str_split_fixed</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">label_df</span>),<span class="cm-string">"</span><span class="cm-string-2">\\</span><span class="cm-string">."</span>,<span class="cm-number">5</span>)[,<span class="cm-number">4</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># plot</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">x</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">seurat_celltype</span> <span class="cm-operator">=</span> <span class="cm-variable">Idents</span>(<span class="cm-variable">pbmc</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">label_df</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cbind</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>, <span class="cm-variable">x</span>, <span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plist</span> <span class="cm-operator">=</span> <span class="cm-variable">lapply</span>(<span class="cm-variable">colnames</span>(<span class="cm-variable">x</span>), <span class="cm-keyword">function</span>(<span class="cm-variable">col</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span><span class="cm-operator">=</span><span class="cm-string">"umap"</span>, <span class="cm-variable">group.by</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>, <span class="cm-variable">label</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>, <span class="cm-variable">pt.size</span> <span class="cm-operator">=</span> <span class="cm-number">1.5</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">labs</span>(<span class="cm-variable">title</span> <span class="cm-operator">=</span> <span class="cm-variable">col</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">#scale_colour_d3("category20") + </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"scibet_compare_all_1.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-variable">plist</span>[<span class="cm-operator">-</span><span class="cm-number">4</span>], <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">11</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">11</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"scibet_compare_all_2.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-variable">plist</span>[<span class="cm-number">4</span>], <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">11</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">writeLines</span>(<span class="cm-variable">capture.output</span>(<span class="cm-variable">sessionInfo</span>()), <span class="cm-string">"sessionInfo.txt"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 2728px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2728px;"></div></div></div></pre><ol start='5' ><li><span>PanglaoDB</span></li></ol><p><img src="images/image-20220107171424266.png" referrerpolicy="no-referrer"></p><p><span>根据数据类型，选择所想要的marker参考基因集。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">celltype</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.table</span>(<span class="cm-string">'PanglaoDB_markers_27_Mar_2020.tsv'</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">sep</span> <span class="cm-operator">=</span> <span class="cm-string">'</span><span class="cm-string-2">\t</span><span class="cm-string">'</span>,<span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>,<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">F</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">iHyperGD</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-keyword">function</span>(<span class="cm-variable">backGround</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">geneNum.pathway</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">geneNum.check</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">geneNum.located</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">1</span><span class="cm-operator">-</span><span class="cm-variable">phyper</span>(<span class="cm-variable">geneNum.located</span><span class="cm-operator">-</span><span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">geneNum.pathway</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">backGround</span> <span class="cm-operator">-</span> <span class="cm-variable">geneNum.pathway</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">geneNum.check</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">lower.tail</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">hyperType</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-keyword">function</span>(<span class="cm-variable">genes</span>,<span class="cm-variable">type</span>,<span class="cm-variable">backGround</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">geneNum.pathway</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">length</span>(<span class="cm-variable">which</span>(<span class="cm-variable">celltype</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell.type</span> <span class="cm-operator">==</span> <span class="cm-variable">type</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">geneNum.check</span> &nbsp; <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">length</span>(<span class="cm-variable">genes</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">geneNum.located</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">sum</span>(<span class="cm-variable">genes</span> <span class="cm-operator cm-variable-2">%in%</span> <span class="cm-variable">celltype</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">official.gene.symbol</span>[<span class="cm-variable">which</span>(<span class="cm-variable">celltype</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell.type</span> <span class="cm-operator">==</span> <span class="cm-variable">type</span>)])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">iHyperGD</span>(<span class="cm-variable">backGround</span>,<span class="cm-variable">geneNum.pathway</span>,<span class="cm-variable">geneNum.check</span>,<span class="cm-variable">geneNum.located</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cellTypeEst_hyper</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-keyword">function</span>(<span class="cm-variable">cluster</span>,<span class="cm-variable">m</span>,<span class="cm-variable">backGround</span> <span class="cm-operator">=</span> <span class="cm-number">2000</span>,<span class="cm-variable">type</span> <span class="cm-operator">=</span> <span class="cm-atom">NA</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">m</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">gene</span>[<span class="cm-variable">which</span>(<span class="cm-variable">m</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">cluster</span> <span class="cm-operator">==</span> <span class="cm-variable">cluster</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">p.val</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">c</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">is.na</span>(<span class="cm-variable">type</span>)){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">Type</span> <span class="cm-keyword">in</span> <span class="cm-variable">unique</span>(<span class="cm-variable">celltype</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell.type</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">p.val</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">c</span>(<span class="cm-variable">p.val</span>,<span class="cm-variable">hyperType</span>(<span class="cm-variable">genes</span>,<span class="cm-variable">Type</span>,<span class="cm-variable">backGround</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">names</span>(<span class="cm-variable">p.val</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">unique</span>(<span class="cm-variable">celltype</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">cell.type</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">sort</span>(<span class="cm-variable">p.val</span>,<span class="cm-variable">decreasing</span> <span class="cm-operator">=</span> <span class="cm-variable">F</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 一次一个分簇</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cellTypeEst_hyper</span>(<span class="cm-number">2</span>,<span class="cm-variable">m</span><span class="cm-operator">=</span><span class="cm-variable">pbmc.markers</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable">i</span> <span class="cm-keyword">in</span> (<span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">6</span>)){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">print</span>(<span class="cm-variable">cellTypeEst_hyper</span>(<span class="cm-variable">i</span>,<span class="cm-variable">m</span><span class="cm-operator">=</span><span class="cm-variable">pbmc.markers</span>)[<span class="cm-number">1</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 880px;"></div><div class="CodeMirror-gutters" style="display: none; height: 880px;"></div></div></div></pre><p>&nbsp;</p><h4 id='构建单细胞轨迹'><span>构建单细胞轨迹</span></h4><p><span>主要使用Monocle2和Monocle3包。</span></p><blockquote><p><span>伪时间分析</span></p></blockquote><p><span>其功能基于单细胞转录组的表达矩阵，通过无监督学习（Reversed Graph Embedding算法）的方式将细胞置于发育轨迹的不同分支上，从而模拟细胞群体生物学过程。也就是我们经常说的拟时序（pseudotime）分析，又称细胞轨迹（cell trajectory）分析。通过拟时序分析可以推断出发育过程细胞的分化轨迹或细胞亚型的演化过程，主要基于关键基因的表达模式，通过学习每个细胞必须经历的基因表达变化的序列，根据拟时间值中对单个细胞进行排序，模拟出时间发育过程的动态变化。</span>
<br><span> </span>
<b><mark><span>伪时间是衡量单个细胞通过细胞分化等过程取得多少进展的指标 </span></mark></b><span>Monocle 不是跟踪作为时间函数的表达变化，而是跟踪作为沿轨迹进展的函数的变化，我们称之为伪时间。伪时间是一个抽象的进程单位：它只是一个单元格和轨迹起点之间的距离，沿着最短路径测量。轨迹的总长度是根据细胞从起始状态移动到结束状态时所经历的转录变化总量来定义的。</span></p><blockquote><p><span>步骤</span></p></blockquote><ol start='' ><li><span>导入数据，创建CellDataSet 类的对象</span></li></ol><ul><li><span>导入数据，创建CellDataSet 类的对象</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_expr_matrix</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.table</span>(<span class="cm-string">"fpkm_matrix.txt"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_sample_sheet</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.delim</span>(<span class="cm-string">"cell_sample_sheet.txt"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_gene_annotation</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.delim</span>(<span class="cm-string">"gene_annotations.txt"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">HSMM_sample_sheet</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">HSMM_gene_annotation</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">as.matrix</span>(<span class="cm-variable">HSMM_expr_matrix</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>, <span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">rm</span>(<span class="cm-builtin">list</span><span class="cm-operator">=</span><span class="cm-variable">ls</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 加载需要的R包</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">monocle</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置cell ranger输出结果目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">input_dir</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"/Users/hecate/研一/blood_vessels_scRNA/matrix/BK-1111_matrix_10X"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 读取数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Read10X</span>(<span class="cm-variable">input_dir</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">CreateSeuratObject</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">project</span> <span class="cm-operator">=</span> <span class="cm-string">"pbmc10k"</span>, <span class="cm-variable">min.cells</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>, <span class="cm-variable">min.features</span> <span class="cm-operator">=</span> <span class="cm-number">200</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as</span>(<span class="cm-variable">as.matrix</span>(<span class="cm-variable">pbmc</span>@<span class="cm-variable">assays</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">RNA</span>@<span class="cm-variable">data</span>), <span class="cm-string">'sparseMatrix'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">'AnnotatedDataFrame'</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pbmc</span>@<span class="cm-variable">meta.data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fData</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">gene_short_name</span> <span class="cm-operator">=</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">data</span>), <span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">data</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">'AnnotatedDataFrame'</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">fData</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Construct monocle cds</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">data</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lowerDetectionLimit</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expressionFamily</span> <span class="cm-operator">=</span> <span class="cm-variable">negbinomial.size</span>())</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 726px;"></div><div class="CodeMirror-gutters" style="display: none; height: 726px;"></div></div></div></pre><p><b><span>导入和导出Seurat或者scater包的数据</span><font color=#FF0000><span>（在做拟时序之前，最好先跑完seurat标准流程，并注释好细胞类型。）</span></b></font></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_expr_matrix</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.table</span>(<span class="cm-string">"fpkm_matrix.txt"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_sample_sheet</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.delim</span>(<span class="cm-string">"cell_sample_sheet.txt"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_gene_annotation</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">read.delim</span>(<span class="cm-string">"gene_annotations.txt"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">HSMM_sample_sheet</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">HSMM_gene_annotation</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">as.matrix</span>(<span class="cm-variable">HSMM_expr_matrix</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>, <span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 与Seurat，scater等R包的交互</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## 导入 importCDS()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Where 'data_to_be_imported' can either be a Seurat object</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># or an SCESet.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">importCDS</span>(<span class="cm-variable">data_to_be_imported</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># We can set the parameter 'import_all' to TRUE if we'd like to</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># import all the slots from our Seurat object or SCESet.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># (Default is FALSE or only keep minimal dataset)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">importCDS</span>(<span class="cm-variable">data_to_be_imported</span>, <span class="cm-variable">import_all</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## 导出 exportCDS()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># To convert to Seurat object</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lung_seurat</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">exportCDS</span>(<span class="cm-variable">lung</span>, <span class="cm-string">'Seurat'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># To convert to SCESet</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lung_SCESet</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">exportCDS</span>(<span class="cm-variable">lung</span>, <span class="cm-string">'Scater'</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 594px;"></div><div class="CodeMirror-gutters" style="display: none; height: 594px;"></div></div></div></pre><ul><li><span>选择数据的分布类型❗❗❗️</span>
<span>Monocle 适用于相对表达数据和基于计数的测量（例如 UMI）。一般来说，它最适用于转录本计数数据，尤其是 UMI 数据。</span><font color=#FF0000><span>FPKM/TPM 值通常呈对数正态分布，而 UMI 或读取计数更适合使用负二项式分布建模。</span></font></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">count_matrix</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expressionFamily</span><span class="cm-operator">=</span><span class="cm-variable">negbinomial.size</span>())</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><table>
<tbody><tr><td>negbinomial.size()</td><td>UMI、来自掺入实验的转录本计数或relative2abs()原始读取计数</td></tr>
<tr><td>negbinomial()</td><td>UMI、来自掺入实验的转录本计数或relative2abs原始读取计数</td></tr>
<tr><td>tobit()</td><td>FPKM、TPM</td></tr>
<tr><td>gaussianff()</td><td>对数转换的 FPKM/TPM，来自单细胞 qPCR 的 Ct 值</td></tr>
</tbody></table><ul><li><span>使用大型数据集（推荐）</span>
<span>使用</span><em><span>稀疏矩阵</span></em><span>可以帮助您在典型计算机上处理大量数据集。我们通常建议大多数用户使用 sparseMatrices，因为它可以加速许多计算，即使对于较小规模的数据集也是如此。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">as</span>(<span class="cm-variable">umi_matrix</span>, <span class="cm-string">"sparseMatrix"</span>),</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lowerDetectionLimit</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expressionFamily</span> <span class="cm-operator">=</span> <span class="cm-variable">negbinomial.size</span>())</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p><span>❗❗❗️许多 RNA-Seq 流程（包括 CellRanger）的输出已经是稀疏矩阵格式（例如 MTX）。这时直接将其传递给newCellDataSet，而无需先将其转换为密集矩阵（通过as.matrix()，因为这可能会超出可用内存。</span>
<br><span>如果使用的是</span><font color=#0000FF><span>10X Genomics 数据并且正在使用cellrangerRkit，使用下列代码进行加载该数据。</span></font></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cellranger_pipestance_path</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"/path/to/your/pipeline/output/directory"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gbm</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">load_cellranger_matrix</span>(<span class="cm-variable">cellranger_pipestance_path</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">fData</span>(<span class="cm-variable">gbm</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># The number 2 is picked arbitrarily in the line below.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Where "2" is placed you should place the column number that corresponds to your</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># featureData's gene short names.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">colnames</span>(<span class="cm-variable">fd</span>)[<span class="cm-number">2</span>] <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-string">"gene_short_name"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gbm_cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">newCellDataSet</span>(<span class="cm-variable">exprs</span>(<span class="cm-variable">gbm</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">phenoData</span> <span class="cm-operator">=</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">gbm</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">featureData</span> <span class="cm-operator">=</span> <span class="cm-variable">new</span>(<span class="cm-string">"AnnotatedDataFrame"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">fd</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lowerDetectionLimit</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expressionFamily</span> <span class="cm-operator">=</span> <span class="cm-variable">negbinomial.size</span>())</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><ul><li><span>🔺估计尺寸因子和分散</span><font color=#FF0000><span>（需要）</span></font>
<br><span>尺寸因子帮助我们对跨细胞恢复的 mRNA 差异进行标准化。</span>
<br><span>“分散”值将帮助我们稍后进行差异表达分析。</span>
<br><b><span>要求：</span></b>
<code>stimateSizeFactors()</code><span>和</span><code>estimateDispersions()</code><span>仅在使用带有</span><code>negbinomial()``ornegbinomial.size()</code><span>的 </span><code>CellDataSet</code><span> 时才有效。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">estimateSizeFactors</span>(<span class="cm-variable">HSMM</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">estimateDispersions</span>(<span class="cm-variable">HSMM</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><ul><li><span>过滤低质量细胞（推荐）</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看细胞中 mRNA 总数的分布</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Matrix</span><span class="cm-operator">::</span><span class="cm-variable">colSums</span>(<span class="cm-variable">exprs</span>(<span class="cm-variable">HSMM</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">HSMM</span>[,<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span> <span class="cm-operator">&lt;</span> <span class="cm-number">1</span><span class="cm-variable">e6</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">upper_bound</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-number">10</span><span class="cm-operator">^</span>(<span class="cm-variable">mean</span>(<span class="cm-variable">log10</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span>)) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">2</span><span class="cm-operator">*</span><span class="cm-variable">sd</span>(<span class="cm-variable">log10</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lower_bound</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-number">10</span><span class="cm-operator">^</span>(<span class="cm-variable">mean</span>(<span class="cm-variable">log10</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span>)) <span class="cm-operator">-</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">2</span><span class="cm-operator">*</span><span class="cm-variable">sd</span>(<span class="cm-variable">log10</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">qplot</span>(<span class="cm-variable">Total_mRNAs</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>), <span class="cm-variable">color</span> <span class="cm-operator">=</span> <span class="cm-variable">Hours</span>, <span class="cm-variable">geom</span> <span class="cm-operator">=</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"density"</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">geom_vline</span>(<span class="cm-variable">xintercept</span> <span class="cm-operator">=</span> <span class="cm-variable">lower_bound</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">geom_vline</span>(<span class="cm-variable">xintercept</span> <span class="cm-operator">=</span> <span class="cm-variable">upper_bound</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><img src="images/2021-10-25-15-16-27.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">HSMM</span>[,<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">lower_bound</span> <span class="cm-operator">&amp;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">pData</span>(<span class="cm-variable">HSMM</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Total_mRNAs</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">upper_bound</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">detectGenes</span>(<span class="cm-variable">HSMM</span>, <span class="cm-variable">min_expr</span> <span class="cm-operator">=</span> <span class="cm-number">0.1</span>) <span class="cm-comment">#计算每个基因在多少细胞中表达</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 验证CellDataSet 是否遵循大致对数正态分布</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Log-transform each value in the expression matrix.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">L</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">log</span>(<span class="cm-variable">exprs</span>(<span class="cm-variable">HSMM</span>[<span class="cm-variable">expressed_genes</span>,]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Standardize each gene, so that they are all on the same scale,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Then melt the data with plyr so we can plot it easily</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">melted_dens_df</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">melt</span>(<span class="cm-variable">Matrix</span><span class="cm-operator">::</span><span class="cm-variable">t</span>(<span class="cm-variable">scale</span>(<span class="cm-variable">Matrix</span><span class="cm-operator">::</span><span class="cm-variable">t</span>(<span class="cm-variable">L</span>))))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Plot the distribution of the standardized gene expression values.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">qplot</span>(<span class="cm-variable">value</span>, <span class="cm-variable">geom</span> <span class="cm-operator">=</span> <span class="cm-string">"density"</span>, <span class="cm-variable">data</span> <span class="cm-operator">=</span> <span class="cm-variable">melted_dens_df</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">stat_function</span>(<span class="cm-variable">fun</span> <span class="cm-operator">=</span> <span class="cm-variable">dnorm</span>, <span class="cm-variable">size</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">color</span> <span class="cm-operator">=</span> <span class="cm-string">'red'</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">xlab</span>(<span class="cm-string">"Standardized log(FPKM)"</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ylab</span>(<span class="cm-string">"Density"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 374px;"></div><div class="CodeMirror-gutters" style="display: none; height: 374px;"></div></div></div></pre><p><img src="images/2021-10-25-15-16-45.png" referrerpolicy="no-referrer"></p><ol start='2' ><li><span>聚类和细胞类型注释（一般推荐使用Seurat的标准流程）</span></li></ol><ul><li><b><span>Step1: 选择定义细胞进程的基因（特征选择）</span></b></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 选择的基因随着我们正在研究的过程的进展而增加（或减少）表达（差异表达的基因）</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## 分离一组排序基因的一种有效方法是简单地将过程开始时收集的细胞与过程结束时收集的细胞进行比较，并找到差异表达的基因</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">diff_test_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">differentialGeneTest</span>(<span class="cm-variable">HSMM_myo</span>[<span class="cm-variable">expressed_genes</span>,],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">fullModelFormulaStr</span> <span class="cm-operator">=</span> <span class="cm-string">"~Media"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ordering_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span> (<span class="cm-variable">subset</span>(<span class="cm-variable">diff_test_res</span>, <span class="cm-variable">qval</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0.01</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 无时间序列数据时</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_myo</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">setOrderingFilter</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">ordering_genes</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_ordering_genes</span>(<span class="cm-variable">HSMM_myo</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><ul><li><b><span>Step2:降低数据维度</span></b><span> </span>
<br><span>DDRTree: 将高维空间的数据点降至二维，方便可视化</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_myo</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">reduceDimension</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">max_components</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">method</span> <span class="cm-operator">=</span> <span class="cm-string">'DDRTree'</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>❗❗❗️Monocle3使用的降维方法为UMAP和tSNE</span></p><ul><li><b><span>Step3: 沿轨迹对细胞进行排序</span></b>
<br><span>轨迹具有树状结构。我们可以看到，在时间零收集的细胞位于树尖之一附近，而其他细胞分布在两个“树枝”之间。Monocle 不知道先验地 将树的哪个轨迹称为“开始”，因此对</span><code>orderCells</code><span>使用</span><code>root_state</code><span>参数再次调用以指定开始。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_myo</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">orderCells</span>(<span class="cm-variable">HSMM_myo</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## ❗️设定根结点，需要根据后续的图来进一步确定最佳的根结点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mycds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">orderCells</span>(<span class="cm-variable">mycds</span>, <span class="cm-variable">root_state</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## 结果可视化</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## Hours轨迹分布图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_cell_trajectory</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"Hours"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><p><img src="images/2021-10-25-15-19-54.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在时间零收集的细胞位于树尖之一附近，而其他细胞分布在两个“树枝”之间。Monocle 不知道先验地将树的哪个轨迹称为“开始”，因此我们需要再次调参以指定开始。</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 通过“state”为细胞着色</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_cell_trajectory</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"State"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><img src="images/2021-10-25-15-20-16.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 通过识别包含从时间零开始的大部分细胞的状态</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">GM_state</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-keyword">function</span>(<span class="cm-variable">cds</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">length</span>(<span class="cm-variable">unique</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">State</span>)) <span class="cm-operator">&gt;</span> <span class="cm-number">1</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">T0_counts</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">table</span>(<span class="cm-variable">pData</span>(<span class="cm-variable">cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">State</span>, <span class="cm-variable">pData</span>(<span class="cm-variable">cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">Hours</span>)[,<span class="cm-string">"0"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">return</span>(<span class="cm-variable">as.numeric</span>(<span class="cm-variable">names</span>(<span class="cm-variable">T0_counts</span>)[<span class="cm-variable">which</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-variable">T0_counts</span> <span class="cm-operator">==</span> <span class="cm-variable">max</span>(<span class="cm-variable">T0_counts</span>))]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">return</span> (<span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##Pseudotime轨迹图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_myo</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">orderCells</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">root_state</span> <span class="cm-operator">=</span> <span class="cm-variable">GM_state</span>(<span class="cm-variable">HSMM_myo</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_cell_trajectory</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"Pseudotime"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><p><img src="images/2021-10-25-15-24-53.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># “分面”轨迹图</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_cell_trajectory</span>(<span class="cm-variable">HSMM_myo</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"State"</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">facet_wrap</span>(<span class="cm-operator">~</span><span class="cm-variable">State</span>, <span class="cm-variable">nrow</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p><img src="images/2021-10-25-15-25-09.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 无时间序列，需先验知识，根据某些标记基因的表达位置来设置根</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">blast_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">fData</span>(<span class="cm-variable">HSMM_myo</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gene_short_name</span> <span class="cm-operator cm-variable-2">%in%</span> <span class="cm-variable">c</span>(<span class="cm-string">"CCNB2"</span>, <span class="cm-string">"MYOD1"</span>, <span class="cm-string">"MYOG"</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_jitter</span>(<span class="cm-variable">HSMM_myo</span>[<span class="cm-variable">blast_genes</span>,],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">grouping</span> <span class="cm-operator">=</span> <span class="cm-string">"State"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">min_expr</span> <span class="cm-operator">=</span> <span class="cm-number">0.1</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><p><img src="images/2021-10-25-15-25-26.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 为了确认排序是正确的，绘制选择的基因的表达水平</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_expressed_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> &nbsp;<span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">fData</span>(<span class="cm-variable">HSMM_myo</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">num_cells_expressed</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">10</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HSMM_filtered</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">HSMM_myo</span>[<span class="cm-variable">HSMM_expressed_genes</span>,]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">my_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">fData</span>(<span class="cm-variable">HSMM_filtered</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">gene_short_name</span> <span class="cm-operator cm-variable-2">%in%</span> <span class="cm-variable">c</span>(<span class="cm-string">"CDK1"</span>, <span class="cm-string">"MEF2C"</span>, <span class="cm-string">"MYH3"</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds_subset</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">HSMM_filtered</span>[<span class="cm-variable">my_genes</span>,]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_in_pseudotime</span>(<span class="cm-variable">cds_subset</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"Hours"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><img src="images/2021-10-25-15-25-47.png" referrerpolicy="no-referrer"></p><p><b><span>补充：</span></b><span>可以通过选择发育差异表达基因，选择clusters差异表达基因，选择离散程度高的基因。自定义发育marker基因来选择基因，前三个为无监督方法，最后一个为半监督分析，需要先验知识。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##使用seurat选择的高变基因⚠️</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">express_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">VariableFeatures</span>(<span class="cm-variable">pbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">setOrderingFilter</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">express_genes</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_ordering_genes</span>(<span class="cm-variable">cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##使用clusters差异表达marker基因</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">deg.cluster</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindAllMarkers</span>(<span class="cm-variable">pbmc</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">express_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">subset</span>(<span class="cm-variable">deg.cluster</span>,<span class="cm-variable">p_val_adj</span><span class="cm-operator">&lt;</span><span class="cm-number">0.05</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">gene</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">setOrderingFilter</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">express_genes</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_ordering_genes</span>(<span class="cm-variable">cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##使用monocle选择的高变基因⚠️</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">disp_table</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">dispersionTable</span>(<span class="cm-variable">cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">disp.genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">subset</span>(<span class="cm-variable">disp_table</span>, <span class="cm-variable">mean_expression</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0.1</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">dispersion_empirical</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">1</span> <span class="cm-operator">*</span> <span class="cm-variable">dispersion_fit</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">gene_id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">setOrderingFilter</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">disp.genes</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_ordering_genes</span>(<span class="cm-variable">cds</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 330px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><blockquote><p><span>Monocle3</span>
<span>其中，Monocle3与Monocle2的区别在于：</span></p></blockquote><ul><li><span>从UMAP图识别发育轨迹，可以继承Seurat的质控、批次校正和降维分析结果，实现“一张图”展现细胞的聚类、鉴定和轨迹分析结果。</span></li><li><span>自动对UMAP图分区（partition），可以选择多个起点，轨迹分析算法的逻辑更符合生物学现实。</span></li><li><span>将拟合一个主图在每个分区内使用learn_graph()函数，为了将细胞排列整齐，我们通过选择我们标记为轨迹“根”的图形区域来确定生物过程的“开始”在哪里。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">monocle3</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">Seurat</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggplot2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">library</span>(<span class="cm-variable">ggsci</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. create</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># pbmc.data &lt;- Read10X(data.dir = "~/project/10x_sc/data/pbmc3k/filtered_gene_bc_matrices_h19")</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc.data</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Read10X</span>(<span class="cm-variable">data.dir</span> <span class="cm-operator">=</span> <span class="cm-string">"~/filtered_gene_bc_matrices_h19"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">satija</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">readRDS</span>(<span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"/home/renjun/filtered_gene_bc_matrices_h19/pbmc3k_final.rds"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">expr_matrix</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">as.matrix</span>(<span class="cm-variable">pbmc.data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sample_sheet</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-variable">colnames</span>(<span class="cm-variable">pbmc.data</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">colnames</span>(<span class="cm-variable">pbmc.data</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gene_annotation</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">data.frame</span>(<span class="cm-variable">row.names</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">pbmc.data</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">id</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">pbmc.data</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">gene_short_name</span> <span class="cm-operator">=</span> <span class="cm-variable">rownames</span>(<span class="cm-variable">pbmc.data</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stringsAsFactors</span> <span class="cm-operator">=</span> <span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">new_cell_data_set</span>(<span class="cm-variable">expr_matrix</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_metadata</span> <span class="cm-operator">=</span> <span class="cm-variable">sample_sheet</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">gene_metadata</span> <span class="cm-operator">=</span> <span class="cm-variable">gene_annotation</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># cds &lt;- load_mm_data(mat_path = "~/filtered_gene_bc_matrices_h19/matrix.mtx", </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; feature_anno_path = "~/filtered_gene_bc_matrices_h19/genes.tsv", </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cell_anno_path = "~/filtered_gene_bc_matrices_h19/barcodes.tsv")</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. preprocessing</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">preprocess_cds</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">num_dim</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>, <span class="cm-variable">norm_method</span> <span class="cm-operator">=</span> <span class="cm-string">"log"</span>, <span class="cm-variable">scaling</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"pv_variance.png"</span>, <span class="cm-variable">plot_pc_variance_explained</span>(<span class="cm-variable">cds</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. reduce dimension</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">reduce_dimension</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">max_components</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>, <span class="cm-variable">preprocess_method</span> <span class="cm-operator">=</span> <span class="cm-string">"PCA"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">reduce_dimension</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">max_components</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"tSNE"</span>, <span class="cm-variable">preprocess_method</span> <span class="cm-operator">=</span> <span class="cm-string">"PCA"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># cds &lt;- align_cds(cds, alignment_group = "batch", residual_model_formula_str = "~ bg.300.loading + bg.400.loading")</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># marker &lt;- c("MS4A1", "GNLY", "CD3E", "CD14", "FCER1A", "FCGR3A", </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  "LYZ", "PPBP", "CD8A","IL7R","CCR7","S100A4")</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 4. clustering</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cluster_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>, <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>, <span class="cm-variable">cluster_method</span> <span class="cm-operator">=</span> <span class="cm-string">"leiden"</span>, <span class="cm-variable">resolution</span> <span class="cm-operator">=</span> <span class="cm-number">1e-4</span>) <span class="cm-comment">#default</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cluster_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"tSNE"</span>, <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>, <span class="cm-variable">cluster_method</span> <span class="cm-operator">=</span> <span class="cm-string">"leiden"</span>, <span class="cm-variable">resolution</span> <span class="cm-operator">=</span> <span class="cm-number">1e-2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">cluster_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"PCA"</span>, <span class="cm-variable">k</span> <span class="cm-operator">=</span> <span class="cm-number">20</span>, <span class="cm-variable">cluster_method</span> <span class="cm-operator">=</span> <span class="cm-string">"louvain"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># cds@clusters@listData$PCA$clusters</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># plot cell with cluster</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>, <span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"cluster"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_size</span> <span class="cm-operator">=</span> <span class="cm-number">2.3</span>, <span class="cm-variable">alpha</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">group_label_size</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"tSNE"</span>, <span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"cluster"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_size</span> <span class="cm-operator">=</span> <span class="cm-number">2.3</span>, <span class="cm-variable">alpha</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">group_label_size</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p3</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"PCA"</span>, <span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"cluster"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_size</span> <span class="cm-operator">=</span> <span class="cm-number">2.3</span>, <span class="cm-variable">alpha</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">group_label_size</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"2d_cluster.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-builtin">list</span>(<span class="cm-variable">p1</span>,<span class="cm-variable">p2</span>,<span class="cm-variable">p3</span>), <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">12</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># plot cell with partition</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p1</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>, <span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"partition"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_size</span> <span class="cm-operator">=</span> <span class="cm-number">2.3</span>, <span class="cm-variable">alpha</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">group_label_size</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p2</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"tSNE"</span>, <span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"partition"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_size</span> <span class="cm-operator">=</span> <span class="cm-number">2.3</span>, <span class="cm-variable">alpha</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">group_label_size</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p3</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"PCA"</span>, <span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"partition"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_size</span> <span class="cm-operator">=</span> <span class="cm-number">2.3</span>, <span class="cm-variable">alpha</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>, <span class="cm-variable">group_label_size</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>) <span class="cm-operator">+</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scale_colour_d3</span>(<span class="cm-string">"category20"</span>) <span class="cm-operator">+</span> &nbsp;<span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"2d_partition.png"</span>, <span class="cm-variable">CombinePlots</span>(<span class="cm-builtin">list</span>(<span class="cm-variable">p1</span>,<span class="cm-variable">p2</span>,<span class="cm-variable">p3</span>), <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>), <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">12</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 5. find marker</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">marker_test_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">top_markers</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">group_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"cluster"</span>, <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>, <span class="cm-variable">reference_cells</span> <span class="cm-operator">=</span> <span class="cm-number">1000</span>, <span class="cm-variable">cores</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">top_specific_markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">marker_test_res</span> <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">filter</span>(<span class="cm-variable">fraction_expressing</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">0.10</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">group_by</span>(<span class="cm-variable">cell_group</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">top_n</span>(<span class="cm-number">10</span>, <span class="cm-variable">pseudo_R2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">top_specific_marker_ids</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">unique</span>(<span class="cm-variable">top_specific_markers</span> <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">pull</span>(<span class="cm-variable">gene_id</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_genes_by_group</span>(<span class="cm-variable">cds</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">top_specific_marker_ids</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">group_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"cluster"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ordering_type</span> <span class="cm-operator">=</span> <span class="cm-string">"maximal_on_diag"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">max.size</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"top_gene10_heatmap.png"</span>, <span class="cm-variable">p</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 6. choose cells for a subset</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds_subset</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">choose_cells</span>(<span class="cm-variable">cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 7. learn the trajectory</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">learn_graph</span>(<span class="cm-variable">cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Passing the programatically selected root node to order_cells() via the root_pr_nodeargument yields:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">order_cells</span>(<span class="cm-variable">cds</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">p</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">color_cells_by</span> <span class="cm-operator">=</span> <span class="cm-string">"pseudotime"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">reduction_method</span> <span class="cm-operator">=</span> <span class="cm-string">"UMAP"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">label_groups_by_cluster</span><span class="cm-operator">=</span><span class="cm-variable">FALSE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">label_leaves</span><span class="cm-operator">=</span><span class="cm-variable">TRUE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">label_branch_points</span><span class="cm-operator">=</span><span class="cm-variable">FALSE</span>) <span class="cm-operator">+</span> <span class="cm-variable">rj.ftheme</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ggsave</span>(<span class="cm-string">"pseudotime2.png"</span>, <span class="cm-variable">p</span>, <span class="cm-variable">width</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>, <span class="cm-variable">height</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">save</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"cds.rda"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 2882px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2882px;"></div></div></div></pre><h3 id='基因水平'><span>基因水平</span></h3><h4 id='基因的差异表达分析'><span>基因的差异表达分析</span></h4><p><span>[❗️❗️❗️该步骤一般在聚类分析之后，细胞类型注释之前进行]</span></p><h5 id='寻找差异表达的特征基因簇生物标志物）'><span>寻找差异表达的特征基因（簇生物标志物）</span></h5><blockquote><p><span>Seurat包</span></p></blockquote><ol start='' ><li><span>运行非线性降维❗️❗️❗️</span></li></ol><p><span>Seurat提供几个非线性降维方法，如tSNE和UMAP，来可视化和探索这些数据集。这些算法的目标是学习数据的底层流形，以便将相似的细胞放在低维空间中。上面确定的基于图形的簇中的细胞应该共同定位在这些降维图中。作为 UMAP 和 tSNE 的输入，我们建议使用相同的 PC 作为聚类分析的输入。由于t-SNE所使用的时间较长，一般使用UMAP。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># If you haven't installed UMAP, you can do so via reticulate::py_install(packages =</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 'umap-learn')</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">RunUMAP</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">dims</span> <span class="cm-operator">=</span> <span class="cm-number">1</span><span class="cm-operator">:</span><span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># note that you can set `label = TRUE` or use the LabelClusters function to help label</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># individual clusters</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DimPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">reduction</span> <span class="cm-operator">=</span> <span class="cm-string">"umap"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># save the data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">saveRDS</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-string">"../output/pbmc_tutorial.rds"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><img src="images/2021-10-25-15-40-12.png" referrerpolicy="no-referrer">
<br></p><ol start='2' ><li><span>marker基因的识别</span>
<br><span>找到通过差异表达定义聚类的标记基因。默认情况下，</span><code>ident.1</code><span>与所有其他细胞相比，它识别单个簇（在</span><code>ident.1</code><span>中指定）的阳性和阴性标记。</span><code>FindAllMarkers()</code><span>为所有簇自动执行此过程，但也可以测试簇与簇之间的对比，或针对所有细胞进行测试。</span>
<br><span>该</span><code>min.pct</code><span>参数要求在两组细胞中的任何一组中以最小百分比检测到一个基因，而 </span><code>thresh.test</code><span>参数要求一个基因在两组之间差异表达（平均）一定量。可以将这两个都设置为 0，但时间会显着增加，因为这将测试大量不太可能具有高度歧视性的基因。作为加速这些计算的另一个选项，</span><code>max.cells.per.ident</code><span>可以设置。</span>
<br><span>Seurat 有几种差异表达测试，可以使用 test.use 参数进行设置，接着可视化。</span>
<br><span>目前支持以下差异表达测试：</span></li></ol><table>
   <tbody><tr>
      <td>“wilcox”：Wilcoxon 秩和检验（默认）</td>
   </tr>
   <tr>
      <td>“bimod”：单细胞特征表达的似然比检验【默认】</td>
   </tr>
   <tr>
      <td>“roc”：标准 AUC 分类器</td>
   </tr>
   <tr>
      <td>“t”：学生的 t 检验</td>
   </tr>
   <tr>
      <td>“泊松”：假设潜在负二项式分布的似然比检验。仅用于基于 UMI 的数据集</td>
   </tr>
   <tr>
      <td>“negbinom”：假设潜在负二项式分布的似然比检验。仅用于基于 UMI 的数据集</td>
   </tr>
   <tr>
      <td>“LR”：使用逻辑回归框架来确定差异表达的基因。构建逻辑回归模型，分别基于每个特征预测组成员身份，并将其与具有似然比检验的空模型进行比较。</td>
   </tr>
   <tr>
      <td>“MAST”：将细胞检测率视为协变量的 GLM 框架</td>
   </tr>
   <tr>
      <td>“DESeq2”：DE 基于使用负二项分布的模型</td>
   </tr>
   <tr>
      <td></td>
   </tr>
</tbody></table><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># find all markers of cluster 2</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cluster2.markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>, <span class="cm-variable">min.pct</span> <span class="cm-operator">=</span> <span class="cm-number">0.25</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">cluster2.markers</span>, <span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># find all markers distinguishing cluster 5 from clusters 0 and 3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cluster5.markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindMarkers</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">ident.1</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>, <span class="cm-variable">ident.2</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-number">0</span>, <span class="cm-number">3</span>), <span class="cm-variable">min.pct</span> <span class="cm-operator">=</span> <span class="cm-number">0.25</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">head</span>(<span class="cm-variable">cluster5.markers</span>, <span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-number">5</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># find markers for every cluster compared to all remaining cells, report only the positive ones</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc.markers</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">FindAllMarkers</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">only.pos</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>, <span class="cm-variable">min.pct</span> <span class="cm-operator">=</span> <span class="cm-number">0.25</span>, <span class="cm-variable">logfc.threshold</span> <span class="cm-operator">=</span> <span class="cm-number">0.25</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc.markers</span> <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">group_by</span>(<span class="cm-variable">cluster</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">slice_max</span>(<span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>, <span class="cm-variable">order_by</span> <span class="cm-operator">=</span> <span class="cm-variable">avg_log2FC</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">VlnPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"MS4A1"</span>, <span class="cm-string">"CD79A"</span>))</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><img src="images/2021-10-25-15-46-35.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># you can plot raw counts as well</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">VlnPlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"NKG7"</span>, <span class="cm-string">"PF4"</span>), <span class="cm-variable">slot</span> <span class="cm-operator">=</span> <span class="cm-string">"counts"</span>, <span class="cm-variable">log</span> <span class="cm-operator">=</span> <span class="cm-variable">TRUE</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><img src="images/2021-10-25-15-47-12.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">FeaturePlot</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">c</span>(<span class="cm-string">"MS4A1"</span>, <span class="cm-string">"GNLY"</span>, <span class="cm-string">"CD3E"</span>, <span class="cm-string">"CD14"</span>, <span class="cm-string">"FCER1A"</span>, <span class="cm-string">"FCGR3A"</span>, <span class="cm-string">"LYZ"</span>, <span class="cm-string">"PPBP"</span>,<span class="cm-string">"CD8A"</span>))</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><img src="images/2021-10-25-15-47-32.png" referrerpolicy="no-referrer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># DoHeatmap()为给定的细胞和特征生成一个表达热图。在这种情况下，我们为每个簇绘制前 20 个标记（或所有标记，如果小于 20）。</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pbmc.markers</span> <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">group_by</span>(<span class="cm-variable">cluster</span>) <span class="cm-operator cm-variable-2">%&gt;%</span><span class="cm-variable">top_n</span>(<span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>, <span class="cm-variable">wt</span> <span class="cm-operator">=</span> <span class="cm-variable">avg_log2FC</span>) <span class="cm-operator cm-arrow">-&gt;</span> <span class="cm-variable">top10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DoHeatmap</span>(<span class="cm-variable">pbmc</span>, <span class="cm-variable">features</span> <span class="cm-operator">=</span> <span class="cm-variable">top10</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">gene</span>) <span class="cm-operator">+</span> <span class="cm-variable">NoLegend</span>()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p><img src="images/2021-10-25-15-47-46.png" referrerpolicy="no-referrer"></p><h5 id='与伪时间分析相关的差异表达分析'><span>与伪时间分析相关的差异表达分析 </span></h5><blockquote><p><span>Monocle2包</span></p></blockquote><ol start='' ><li><span>寻找随伪时间变化的基因</span></li></ol><p><span>Monocle 的主要工作是在不知道提前查看哪些基因的情况下，将细胞按生物过程（例如细胞分化）的进展顺序排列。可以分析细胞以找到随着细胞进展而发生变化的基因。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">to_be_tested</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">fData</span>(<span class="cm-variable">HSMM</span>),</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gene_short_name</span> <span class="cm-operator cm-variable-2">%in%</span> <span class="cm-variable">c</span>(<span class="cm-string">"MYH3"</span>, <span class="cm-string">"MEF2C"</span>, <span class="cm-string">"CCNB2"</span>, <span class="cm-string">"TNNT1"</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cds_subset</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">HSMM_myo</span>[<span class="cm-variable">to_be_tested</span>,]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Monocle 使用VGAM包将基因的表达水平建模为伪时间的平滑非线性函数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">diff_test_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">differentialGeneTest</span>(<span class="cm-variable">cds_subset</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fullModelFormulaStr</span> <span class="cm-operator">=</span> <span class="cm-string">"~sm.ns(Pseudotime)"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">diff_test_res</span>[,<span class="cm-variable">c</span>(<span class="cm-string">"gene_short_name"</span>, <span class="cm-string">"pval"</span>, <span class="cm-string">"qval"</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_in_pseudotime</span>(<span class="cm-variable">cds_subset</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"Hours"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre><p><img src="images/2021-10-25-16-05-17.png" referrerpolicy="no-referrer"></p><ol start='2' ><li><span>分析单细胞轨迹中的分支</span>
<br><span>分析单细胞轨迹中的分支</span>
<span>e.g. 考虑一下 Steve Quake 实验室由 Barbara Treutlein 和同事进行的实验，他们从发育中的小鼠肺中捕获了细胞。他们在发育早期捕获了细胞，后来当肺包含两种主要类型的上皮细胞（AT1 和 AT2），以及即将决定成为 AT1 或 AT2 的细胞时。Monocle 可以将此过程重建为分支轨迹，让您可以非常详细地分析决策点。下图显示了 Monocle 使用他们的一些数据重建的轨迹。有一个分支，标记为“1”。当细胞从树的左上角的早期发育阶段通过树枝时，哪些基因会发生变化？哪些基因在分支之间差异表达？为了回答这个问题，Monocle 为您提供了一个特殊的统计测试：分支表达式分析建模，或BEAM。</span>
<br></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lung</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">load_lung</span>()</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_cell_trajectory</span>(<span class="cm-variable">lung</span>, <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"Time"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><br><p><img src="images/init_treutlein-1.png" referrerpolicy="no-referrer"></p><p><br>
<span>单细胞轨迹包括分支。分支的出现是因为细胞执行替代基因表达程序。分支出现在发育过程中的轨迹中，当细胞做出命运选择时：一个发育谱系沿着一条路径前进，而另一个谱系产生第二条路径。Monocle采用分支表达式分析建模，主要是BEAM(Branched expression analysis modeling)函数，可以将分叉过程重构为一个分支轨迹，比较分枝点与分枝末端的差异，从而分析不同细胞命运下的差异。</span><mark><span>Monocle可以模拟出每个细胞所处的分化时间，并寻找随着分化时间逐渐升高或降低的基因表达热图和分布图。</span></mark></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># BEAM将已排序的CellDataSetorderCells和轨迹中分支点的名称作为输入。它返回每个基因的显着性分数表。得分显着的基因在其表达中被认为是分支依赖性的。</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">BEAM_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">BEAM</span>(<span class="cm-variable">lung</span>, <span class="cm-variable">branch_point</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>, <span class="cm-variable">cores</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">BEAM_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">BEAM_res</span>[<span class="cm-variable">order</span>(<span class="cm-variable">BEAM_res</span><span class="cm-operator cm-dollar">$</span><span class="cm-variable">qval</span>),]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">BEAM_res</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">BEAM_res</span>[,<span class="cm-variable">c</span>(<span class="cm-string">"gene_short_name"</span>, <span class="cm-string">"pval"</span>, <span class="cm-string">"qval"</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 可以使用特殊类型的热图可视化所有显着依赖于分支的基因的变化。此热图同时显示了两个谱系的变化。它还要求选择要检查的分支点。列是伪时间中的点，行是基因，伪时间的开始位于热图的中间。branch_point=1，分支点选为1，分析branch_point = 1这个分支处的细胞命名分叉是如何进行的。num_clusters=4，将基因根据表达相似性分成4个模块。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_branched_heatmap</span>(<span class="cm-variable">lung</span>[<span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">BEAM_res</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">qval</span> <span class="cm-operator">&lt;</span> <span class="cm-number">1e-4</span>)),],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">branch_point</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">num_clusters</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cores</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">use_gene_short_name</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">show_rownames</span> <span class="cm-operator">=</span> <span class="cm-variable">T</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 可视化所想要研究的基因</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lung_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">row.names</span>(<span class="cm-variable">subset</span>(<span class="cm-variable">fData</span>(<span class="cm-variable">lung</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">gene_short_name</span> <span class="cm-operator cm-variable-2">%in%</span> <span class="cm-variable">c</span>(<span class="cm-string">"Ccnd2"</span>, <span class="cm-string">"Sftpb"</span>, <span class="cm-string">"Pdpn"</span>)))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_branched_pseudotime</span>(<span class="cm-variable">lung</span>[<span class="cm-variable">lung_genes</span>,],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">branch_point</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">color_by</span> <span class="cm-operator">=</span> <span class="cm-string">"Time"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 528px;"></div><div class="CodeMirror-gutters" style="display: none; height: 528px;"></div></div></div></pre><blockquote><p><span>Monocle3包</span></p></blockquote><ol start='' ><li><b><span>回归分析：</span>
<br></b><span>使用</span><code>fit_models()</code><span>，可以评估每个基因是否依赖于时间、治疗等变量。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 适用于研究的生物过程中发现动态调节的基因</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gene_fits</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">fit_models</span>(<span class="cm-variable">cds_subset</span>, <span class="cm-variable">model_formula_str</span> <span class="cm-operator">=</span> <span class="cm-string">"~embryo.time"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fit_coefs</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">coefficient_table</span>(<span class="cm-variable">gene_fits</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 找出具有重要时间分量的基因</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">emb_time_terms</span> <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">filter</span> (<span class="cm-variable">q_value</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0.05</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">select</span>(<span class="cm-variable">gene_short_name</span>, <span class="cm-variable">term</span>, <span class="cm-variable">q_value</span>, <span class="cm-variable">estimate</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 可视化上述测试所揭示的差异</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_violin</span>(<span class="cm-variable">cds_subset</span>, <span class="cm-variable">group_cells_by</span><span class="cm-operator">=</span><span class="cm-string">"embryo.time.bin"</span>, <span class="cm-variable">ncol</span><span class="cm-operator">=</span><span class="cm-number">2</span>) <span class="cm-operator">+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">theme</span>(<span class="cm-variable">axis.text.x</span><span class="cm-operator">=</span><span class="cm-variable">element_text</span>(<span class="cm-variable">angle</span><span class="cm-operator">=</span><span class="cm-number">45</span>, <span class="cm-variable">hjust</span><span class="cm-operator">=</span><span class="cm-number">1</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 控制批次效应和其他因素</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gene_fits</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">fit_models</span>(<span class="cm-variable">cds_subset</span>, <span class="cm-variable">model_formula_str</span> <span class="cm-operator">=</span> <span class="cm-string">"~embryo.time + batch"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fit_coefs</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">coefficient_table</span>(<span class="cm-variable">gene_fits</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">fit_coefs</span> <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">filter</span>(<span class="cm-variable">term</span> <span class="cm-operator">!=</span> <span class="cm-string">"(Intercept)"</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-variable">select</span>(<span class="cm-variable">gene_short_name</span>, <span class="cm-variable">term</span>, <span class="cm-variable">q_value</span>, <span class="cm-variable">estimate</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 评估基因表达模型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">evaluate_fits</span>(<span class="cm-variable">gene_fits</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 完整模型：知道每个细胞被收集的时间和来自哪一批</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">time_batch_models</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">fit_models</span>(<span class="cm-variable">cds_subset</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model_formula_str</span> <span class="cm-operator">=</span> <span class="cm-string">"~embryo.time + batch"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expression_family</span><span class="cm-operator">=</span><span class="cm-string">"negbinomial"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 缩减模型：只知道每个细胞被收集的时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">time_models</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">fit_models</span>(<span class="cm-variable">cds_subset</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">model_formula_str</span> <span class="cm-operator">=</span> <span class="cm-string">"~embryo.time"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expression_family</span><span class="cm-operator">=</span><span class="cm-string">"negbinomial"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">compare_models</span>(<span class="cm-variable">time_batch_models</span>, <span class="cm-variable">time_models</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">select</span>(<span class="cm-variable">gene_short_name</span>, <span class="cm-variable">q_value</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 550px;"></div><div class="CodeMirror-gutters" style="display: none; height: 550px;"></div></div></div></pre><p><span>Monocle的fit_models()支持负二项分布和下表中列出的其他几个分布。</span></p><table>
   <tbody><tr>
      <td>quasipoisson</td>
      <td>准泊松</td>
      <td>默认为fit_models()</td>
   </tr>
   <tr>
      <td>negbinomial</td>
      <td>负二项式</td>
      <td>推荐用于数据集较小（少于 1,000 个细胞）</td>
   </tr>
   <tr>
      <td>poisson</td>
      <td>泊松</td>
      <td>不建议。仅用于调试和测试。</td>
   </tr>
   <tr>
      <td>binomial</td>
      <td>二项式</td>
      <td>推荐用于单细胞 ATAC-seq</td>
   </tr>
</tbody></table><ol start='2' ><li><b><span>图自相关分析：</span><b>
<br><span>使用</span><code>graph_test()</code><span>，可以找到在轨迹上或簇之间变化的基因。</span></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="r" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="r"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##寻找拟时轨迹差异基因</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#graph_test分析最重要的结果是莫兰指数（morans_I），其值在-1至1之间，0代表此基因没有</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#空间共表达效应，1代表此基因在空间距离相近的细胞中表达值高度相似。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Track_genes</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">graph_test</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">neighbor_graph</span><span class="cm-operator">=</span><span class="cm-string">"principal_graph"</span>, <span class="cm-variable">cores</span><span class="cm-operator">=</span><span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#挑选top10画图展示</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Track_genes_sig</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">Track_genes</span> <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">top_n</span>(<span class="cm-variable">n</span><span class="cm-operator">=</span><span class="cm-number">10</span>, <span class="cm-variable">morans_I</span>) <span class="cm-operator cm-variable-2">%&gt;%</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">pull</span>(<span class="cm-variable">gene_short_name</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">as.character</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#基因表达趋势图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_genes_in_pseudotime</span>(<span class="cm-variable">cds</span>[<span class="cm-variable">Track_genes_sig</span>,], <span class="cm-variable">color_cells_by</span><span class="cm-operator">=</span><span class="cm-string">"predicted.id"</span>, </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">min_expr</span><span class="cm-operator">=</span><span class="cm-number">0.5</span>, <span class="cm-variable">ncol</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#FeaturePlot图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">plot_cells</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">genes</span><span class="cm-operator">=</span><span class="cm-variable">Track_genes_sig</span>, <span class="cm-variable">show_trajectory_graph</span><span class="cm-operator">=</span><span class="cm-variable">FALSE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">label_cell_groups</span><span class="cm-operator">=</span><span class="cm-variable">FALSE</span>, &nbsp;<span class="cm-variable">label_leaves</span><span class="cm-operator">=</span><span class="cm-variable">FALSE</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##寻找共表达模块</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">genelist</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">pull</span>(<span class="cm-variable">Track_genes</span>, <span class="cm-variable">gene_short_name</span>) <span class="cm-operator cm-variable-2">%&gt;%</span> <span class="cm-variable">as.character</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">gene_module</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">find_gene_modules</span>(<span class="cm-variable">cds</span>[<span class="cm-variable">genelist</span>,], <span class="cm-variable">resolution</span><span class="cm-operator">=</span><span class="cm-number">1</span><span class="cm-variable">e2</span>, <span class="cm-variable">cores</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cell_group</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">tibble</span><span class="cm-operator">::</span><span class="cm-variable">tibble</span>(<span class="cm-variable">cell</span><span class="cm-operator">=</span><span class="cm-variable">row.names</span>(<span class="cm-variable">colData</span>(<span class="cm-variable">cds</span>)), </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cell_group</span><span class="cm-operator">=</span><span class="cm-variable">colData</span>(<span class="cm-variable">cds</span>)<span class="cm-operator cm-dollar">$</span><span class="cm-variable">predicted.id</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">agg_mat</span> <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">aggregate_gene_expression</span>(<span class="cm-variable">cds</span>, <span class="cm-variable">gene_module</span>, <span class="cm-variable">cell_group</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">row.names</span>(<span class="cm-variable">agg_mat</span>) <span class="cm-operator cm-arrow">&lt;-</span> <span class="cm-variable">stringr</span><span class="cm-operator">::</span><span class="cm-variable">str_c</span>(<span class="cm-string">"Module "</span>, <span class="cm-variable">row.names</span>(<span class="cm-variable">agg_mat</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">pheatmap</span><span class="cm-operator">::</span><span class="cm-variable">pheatmap</span>(<span class="cm-variable">agg_mat</span>, <span class="cm-variable">scale</span><span class="cm-operator">=</span><span class="cm-string">"column"</span>, <span class="cm-variable">clustering_method</span><span class="cm-operator">=</span><span class="cm-string">"ward.D2"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;"></div><div class="CodeMirror-gutters" style="display: none; height: 462px;"></div></div></div></pre><h4 id='基因集分析'><span>基因集分析</span></h4><h5 id='表观遗传分析'><span>表观遗传分析</span></h5><h5 id='富集分析'><span>富集分析</span></h5><h4 id='基因调控网络分析'><span>基因调控网络分析</span></h4><h5 id='基因共表达'><span>基因共表达</span></h5><h5 id='蛋白质互作网络'><span>蛋白质互作网络</span></h5><h5 id='回归模型'><span>回归模型</span></h5><p>&nbsp;</p></div></div>
</body>
</html>